// Beispiel Program.cs Configuration f端r dein Service

var builder = WebApplicationBuilder.CreateBuilder(args);

// ============ Service Registration ============

// Entity Extensions
builder.Services.AddEntityExtensions();

// Model Binding f端r IExtensibleEntity
builder.Services
    .AddControllers(options =>
    {
        // Registriere Custom Model Binder Provider
        options.ModelBinderProviders.Insert(0, 
            new ExtensibleEntityModelBinderProvider());

        // Registriere Custom Input Formatter
        var extensionService = builder.Services
            .BuildServiceProvider()
            .GetRequiredService<IEntityExtensionService>();
        
        var logger = builder.Services
            .BuildServiceProvider()
            .GetRequiredService<ILogger<ExtensibleEntityJsonInputFormatter>>();

        options.InputFormatters.Insert(0,
            new ExtensibleEntityJsonInputFormatter(extensionService, logger));
    })
    .AddJsonOptions(options =>
    {
        // Konfiguriere JSON Serializer f端r Custom Properties
        options.JsonSerializerOptions.PropertyNamingPolicy = JsonNamingPolicy.CamelCase;
        options.JsonSerializerOptions.WriteIndented = false;
    });

// Data Access
builder.Services.AddScoped<IUserRepository, UserRepository>();
builder.Services.AddScoped<IExtensionSchemaRepository, ExtensionSchemaRepository>();
builder.Services.AddScoped<IExtensionAuditRepository, ExtensionAuditRepository>();

// DbContext
builder.Services.AddDbContext<UserDbContext>(options =>
{
    options.UseNpgsql(builder.Configuration.GetConnectionString("DefaultConnection"));
    options.UseSnakeCaseNamingConvention();
});

// MediatR f端r CQRS
builder.Services.AddMediatR(config =>
{
    config.RegisterServicesFromAssembly(typeof(Program).Assembly);
});

// AutoMapper
builder.Services.AddAutoMapper(typeof(Program).Assembly);

// Logging
builder.Services.AddLogging();

// ============ Middleware ============

var app = builder.Build();

// HTTPS Redirection
app.UseHttpsRedirection();

// Authentication & Authorization
app.UseAuthentication();
app.UseAuthorization();

// Map Controllers
app.MapControllers();

app.Run();
