# B2Connect Helm Values
# Default configuration for Kubernetes deployment

# Global settings
global:
  environment: production
  domain: b2connect.local

# Deployment Strategy
deployment:
  type: rolling  # rolling, blue-green, canary
  color: blue    # blue or green (for blue-green)
  canary:
    enabled: false
    replicas: 1
    traffic: 10  # percentage of traffic to canary
  rollback:
    enabled: true
    timeout: 600  # seconds
    healthCheckDelay: 30  # seconds after rollout

# Image settings
image:
  registry: ghcr.io
  repository: yourusername/b2connect
  tag: latest
  pullPolicy: IfNotPresent
  
# PostgreSQL Configuration
postgres:
  enabled: true
  image:
    repository: postgres
    tag: "16-alpine"
    pullPolicy: IfNotPresent
  username: b2connect
  database: b2connect_db
  password: "{{ .Values.secrets.postgres_password }}"
  storage:
    size: 10Gi
    class: standard

# Redis Configuration
redis:
  enabled: true
  image:
    repository: redis
    tag: "7-alpine"
    pullPolicy: IfNotPresent
  storage:
    size: 5Gi
    class: standard

# API Gateway
apiGateway:
  enabled: true
  image:
    repository: b2connect-api-gateway
    tag: latest
    pullPolicy: IfNotPresent
  replicas: 2
  port: 5000
  resources:
    requests:
      cpu: "250m"
      memory: "256Mi"
    limits:
      cpu: "500m"
      memory: "512Mi"
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 5
    targetCPUUtilization: 70

# Auth Service
authService:
  enabled: true
  image:
    repository: b2connect-auth-service
    tag: latest
    pullPolicy: IfNotPresent
  replicas: 2
  port: 5001
  resources:
    requests:
      cpu: "250m"
      memory: "256Mi"
    limits:
      cpu: "500m"
      memory: "512Mi"
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 5
    targetCPUUtilization: 70

# Tenant Service
tenantService:
  enabled: true
  image:
    repository: b2connect-tenant-service
    tag: latest
    pullPolicy: IfNotPresent
  replicas: 2
  port: 5002
  resources:
    requests:
      cpu: "250m"
      memory: "256Mi"
    limits:
      cpu: "500m"
      memory: "512Mi"
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 5
    targetCPUUtilization: 70

# Localization Service
localizationService:
  enabled: true
  image:
    repository: b2connect-localization-service
    tag: latest
    pullPolicy: IfNotPresent
  replicas: 2
  port: 5003
  resources:
    requests:
      cpu: "250m"
      memory: "256Mi"
    limits:
      cpu: "500m"
      memory: "512Mi"
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 5
    targetCPUUtilization: 70

# AppHost (Central Orchestrator)
apphost:
  enabled: true
  image:
    repository: b2connect-apphost
    tag: latest
    pullPolicy: IfNotPresent
  replicas: 1
  port: 9000
  resources:
    requests:
      cpu: "500m"
      memory: "512Mi"
    limits:
      cpu: "1000m"
      memory: "1024Mi"

# Ingress Configuration
ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
  host: "api.b2connect.local"
  tls:
    enabled: true
    secretName: b2connect-tls

# Monitoring
monitoring:
  enabled: true
  prometheus:
    enabled: true
  grafana:
    enabled: true
  alerting:
    enabled: true
    rules:
      - name: high_error_rate
        query: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) > 0.05
        threshold: 0.05
        severity: critical
        description: "High error rate detected"
      - name: slow_response_time
        query: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2.0
        threshold: 2.0
        severity: warning
        description: "Slow response times detected"
      - name: deployment_failure
        query: kube_deployment_status_replicas_unavailable > 0
        threshold: 0
        severity: critical
        description: "Deployment has unavailable replicas"

# Logging
logging:
  level: Information
  serilog:
    enabled: true
    elasticsearch:
      enabled: false
      host: "elasticsearch"
      port: 9200

# Service Discovery
serviceDiscovery:
  enabled: true
  type: kubernetes

# CORS Configuration
cors:
  allowedOrigins:
    - "https://app.b2connect.local"
    - "https://admin.b2connect.local"
  allowedMethods:
    - GET
    - POST
    - PUT
    - DELETE
    - PATCH
  allowedHeaders:
    - "Content-Type"
    - "Authorization"
  allowCredentials: true

# Health Checks
healthChecks:
  enabled: true
  interval: 30000
  timeout: 5000

# Secrets (use sealed-secrets or external-secrets in production)
secrets:
  postgres_password: "change-me-in-production"
  auth_service_connection_string: "Server=postgres;Port=5432;Database=b2connect_auth;User Id=b2connect;Password=change-me-in-production;"
  tenant_service_connection_string: "Server=postgres;Port=5432;Database=b2connect_tenant;User Id=b2connect;Password=change-me-in-production;"
  localization_service_connection_string: "Server=postgres;Port=5432;Database=b2connect_localization;User Id=b2connect;Password=change-me-in-production;"
