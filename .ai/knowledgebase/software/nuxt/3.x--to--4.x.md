# Nuxt 3.x → 4.x Migration Guide

**DocID**: KB-NUXT-4  
**Created**: 7. Januar 2026  
**Status**: Research Complete  
**Author**: @Architect

## Quick Summary

Nuxt 4.0 is a stability-focused major release introducing a new `app/` directory structure, improved TypeScript project separation, smarter data fetching with singleton patterns, and faster CLI/development experience. Most Nuxt 3 projects can upgrade with minimal effort as Nuxt auto-detects existing structures and provides configuration options for backward compatibility.

---

## Breaking Changes

| Change | Nuxt 3 | Nuxt 4 | Migration |
|--------|--------|--------|-----------|
| **Directory Structure** | All code in root (`pages/`, `components/`, etc.) | App code in `app/` directory, `server/` at root | Move app code to `app/` or set `srcDir: '.'` |
| **srcDir Default** | `.` (root) | `app/` | Auto-detected; can revert with config |
| **serverDir Resolution** | `<srcDir>/server` | `<rootDir>/server` | Update paths or configure explicitly |
| **TypeScript Config** | Single `tsconfig.json` extending `.nuxt/` | Separate projects: `app`, `server`, `shared`, `node` | Update to project references (optional) |
| **useAsyncData Default Value** | `data` defaults to `null` | `data` defaults to `undefined` | Update null checks to undefined |
| **useAsyncData Reactivity** | Deep reactivity | Shallow reactivity (shallowRef) | Add `deep: true` if needed |
| **Data Fetching Singleton** | Independent refs per call | Shared refs for same key | Ensure consistent options per key |
| **getCachedData Context** | Called only on initial fetch | Called on every fetch with context | Update to use `ctx.cause` parameter |
| **pending Behavior** | `true` until first request | `false` until request starts (when `immediate: false`) | Update status checks |
| **dedupe Boolean** | `dedupe: true/false` accepted | Must use `'cancel'` or `'defer'` | Replace booleans with strings |
| **window.__NUXT__** | Available after hydration | Removed after hydration | Use `useNuxtApp().payload` |
| **Route Metadata** | Available on `route.meta.name` | Only on `route.name` (deduplicated) | Access directly on route |
| **Component Names** | Vue filename-based | Matches Nuxt auto-import pattern | Update KeepAlive/test refs |
| **Inline Styles** | All CSS inlined | Only Vue component CSS inlined | Set `inlineStyles: true` to revert |
| **builder:watch Paths** | Relative to srcDir | Absolute paths | Resolve with `relative()` for compat |
| **Module Load Order** | Project modules first | Layer modules first, project last | Review if order-dependent |
| **SPA Loading Screen** | Inside `#__nuxt` div | Adjacent to `#__nuxt` div | Update CSS selectors if needed |
| **generate Config** | Top-level `generate` option | Removed (use `nitro.prerender`) | Move to `nitro.prerender` |
| **Unhead** | v1 | v2 (removes `vmid`, `hid`, `children`) | Remove deprecated props |
| **EJS Templates** | Supported via lodash | Removed | Migrate to `getContents()` |
| **Nuxt 2/Bridge Support** | Partial in @nuxt/kit | Completely removed | N/A for B2Connect |

---

## New Features

### Core Features
- **New `app/` Directory Structure**: Cleaner separation of app code from configuration
- **TypeScript Project Splitting**: Separate TS configs for app, server, shared, and node contexts
- **Singleton Data Fetching**: Shared refs across components for same keys
- **Reactive Keys**: Auto-refetch when computed/ref keys change
- **Data Cleanup**: Automatic cleanup when components unmount (memory optimization)
- **AbortController Support** (v4.2+): Fine-grained request cancellation in `useAsyncData`

### Performance Improvements
- **Faster CLI**: Socket-based communication, native file watching, Node.js compile cache
- **Faster Cold Starts**: Noticeable improvement in dev server startup
- **Precomputed Renderer Dependencies**: Build-time computation vs runtime
- **Async Data Handler Extraction** (experimental): Extract handlers to separate chunks (39% bundle reduction in tests)
- **Rolldown Replace Plugin**: Performance improvement in Vite builds

### Developer Experience
- **Better Error Pages**: Dual view with custom error page + technical overlay in dev
- **Chrome DevTools Workspaces Integration**: Better debugging experience
- **Experimental TypeScript Plugin**: Enhanced DX with component renaming, route navigation
- **Route Announcer**: Default accessibility improvement in app.vue
- **Lazy Hydration Macros**: Support for selective hydration strategies

### Experimental Features (v4.2+)
- **Vite Environment API** (`experimental.viteEnvironmentApi`): Better dev/prod alignment
- **Async Data Handler Extraction** (`experimental.extractAsyncDataHandlers`): Bundle size reduction
- **TypeScript Plugin** (`experimental.typescriptPlugin`): Enhanced IDE support

---

## Plugin Compatibility

| Plugin | Status | Notes |
|--------|--------|-------|
| **@nuxtjs/i18n** | ✅ Compatible | v10.x supports Nuxt 4; update to v10.0.0+ for full compatibility |
| **@pinia/nuxt** | ✅ Compatible | Works with Nuxt 3 & 4; auto-imports stores from `app/stores/` |
| **@nuxt/devtools** | ✅ Compatible | Included by default |
| **@nuxtjs/tailwindcss** | ✅ Compatible | Auto-configures for new directory structure |
| **@sentry/vue** | ⚠️ Check | Verify compatibility with Vue 3.5.x |
| **vue-i18n** | ✅ Compatible | v11.x works with @nuxtjs/i18n v10 |
| **daisyui** | ✅ Compatible | Tailwind plugin, no Nuxt-specific issues |

### B2Connect Specific Plugin Updates Required

```json
{
  "@nuxtjs/i18n": "^10.0.0",  // Currently: ^9.1.1 → Update required
  "@pinia/nuxt": "^0.4.11",   // Compatible, no change needed
  "nuxt": "^4.0.0"            // Currently: ^3.15.2 → Update required
}
```

---

## Node.js Requirements

| Version | Node.js | Notes |
|---------|---------|-------|
| Nuxt 3.x | ≥18.0.0 | LTS recommended |
| Nuxt 4.x | ≥20.11.0 | **Node 22 LTS recommended** |

⚠️ **B2Connect Impact**: Verify CI/CD pipelines and development environments use Node.js 20.x or later.

---

## Migration Checklist

### Phase 1: Preparation
- [ ] Ensure Node.js ≥20.11.0 in all environments
- [ ] Run `npx nuxt upgrade --dedupe` to get latest Nuxt 3.x
- [ ] Review breaking changes relevant to B2Connect
- [ ] Back up current configuration and test coverage

### Phase 2: Dependencies
- [ ] Update `nuxt` to `^4.0.0`
- [ ] Update `@nuxtjs/i18n` to `^10.0.0`
- [ ] Run `npm install` / `pnpm install`
- [ ] Run automated codemod: `npx codemod@0.18.7 nuxt/4/migration-recipe`

### Phase 3: Directory Structure (Optional)
- [ ] Create `app/` directory
- [ ] Move: `assets/`, `components/`, `composables/`, `layouts/`, `middleware/`, `pages/`, `plugins/`, `utils/`
- [ ] Move: `app.vue`, `error.vue`, `app.config.ts`
- [ ] Keep at root: `nuxt.config.ts`, `server/`, `public/`
- [ ] **OR** keep existing structure (Nuxt auto-detects)

### Phase 4: Code Updates
- [ ] Update `null` checks to `undefined` for `useAsyncData` data
- [ ] Replace `dedupe: true/false` with `'cancel'`/`'defer'`
- [ ] Update any `window.__NUXT__` usage to `useNuxtApp().payload`
- [ ] Review `getCachedData` implementations for new context parameter
- [ ] Check `useAsyncData` keys for consistency across components
- [ ] Update any `route.meta.name` to `route.name`

### Phase 5: TypeScript (Optional Enhancement)
- [ ] Update `tsconfig.json` to use project references:
  ```json
  {
    "files": [],
    "references": [
      { "path": "./.nuxt/tsconfig.app.json" },
      { "path": "./.nuxt/tsconfig.server.json" },
      { "path": "./.nuxt/tsconfig.shared.json" },
      { "path": "./.nuxt/tsconfig.node.json" }
    ]
  }
  ```
- [ ] Update typecheck script: `"typecheck": "nuxt prepare && vue-tsc -b --noEmit"`
- [ ] Move type augmentations to appropriate directories

### Phase 6: Configuration Updates
- [ ] Update `generate` config to `nitro.prerender` if used
- [ ] Review `experimental` options (some removed/changed defaults)
- [ ] Update Tailwind/ESLint configs if using new `app/` structure

### Phase 7: Testing & Validation
- [ ] Run full test suite
- [ ] Test SSR and CSR modes
- [ ] Verify i18n functionality
- [ ] Test Pinia stores
- [ ] Check bundle size changes
- [ ] Perform E2E testing

---

## B2Connect Specific Considerations

### Current Configuration Analysis

From [nuxt.config.ts](../../../../frontend/Store/nuxt.config.ts):

```typescript
// Current setup
srcDir: 'src',  // Custom srcDir - will continue to work
modules: ['@nuxtjs/i18n', '@pinia/nuxt'],  // Both compatible
```

### Recommended Migration Path for B2Connect

1. **Keep `srcDir: 'src'`**: B2Connect already uses a custom srcDir, so the new `app/` default won't apply
2. **Opt-out of directory migration**: Add explicit configuration to maintain current structure:
   ```typescript
   export default defineNuxtConfig({
     srcDir: 'src',  // Keep existing
     dir: {
       app: 'src',   // Specify app directory location
     },
   })
   ```

3. **Update i18n Module**: The current version `^9.1.1` must be updated to `^10.0.0` for Nuxt 4 compatibility

4. **Consider Data Fetching Changes**: Review all `useAsyncData` and `useFetch` calls for:
   - Consistent options when using same keys
   - Updated `getCachedData` implementations
   - Shallow reactivity implications

---

## Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| TypeScript errors after upgrade | Medium | Use legacy tsconfig initially, migrate incrementally |
| Data fetching behavior changes | Medium | Add `deep: true` where needed; test extensively |
| Plugin incompatibility | Low | All major plugins confirmed compatible |
| Node.js version mismatch | Medium | Update CI/CD and document requirements |
| Bundle size changes | Low | Likely smaller; monitor with existing analysis |
| Module load order changes | Low | Unlikely to affect B2Connect (single layer) |
| i18n v10 breaking changes | Medium | Review i18n v10 changelog before upgrading |
| Custom srcDir complications | Low | Explicitly configure `dir.app` if issues arise |

---

## Rollback Strategy

1. Keep Nuxt 3.x branch available
2. Pin dependencies in `package.json`:
   ```json
   {
     "nuxt": "^3.15.2",
     "@nuxtjs/i18n": "^9.1.1"
   }
   ```
3. Nuxt 3 maintenance updates continue until **January 2026**

---

## Performance Comparison

| Metric | Nuxt 3.x | Nuxt 4.x | Change |
|--------|----------|----------|--------|
| Dev server cold start | Baseline | Faster | ~15-30% improvement |
| HMR speed | Baseline | Faster | Socket-based communication |
| Build time | Baseline | Similar | Minor improvements |
| Bundle size | Baseline | Similar/Smaller | Depends on config |
| Memory usage | Baseline | Lower | Singleton data fetching, cleanup |

---

## Timeline Considerations

- **Nuxt 3.x Maintenance**: Until **End of January 2026**
- **Nuxt 5 Preview**: Available via `future.compatibilityVersion: 5` (Vite Environment API)
- **Recommendation**: Migrate to Nuxt 4 by Q4 2025 to ensure continued support

---

## Recommendation

**✅ PROCEED** with migration to Nuxt 4.x

### Rationale

1. **Low Risk**: Breaking changes are well-documented with clear migration paths
2. **Plugin Compatibility**: All B2Connect plugins have Nuxt 4-compatible versions
3. **Performance Benefits**: Faster development experience and potential bundle improvements
4. **Support Timeline**: Nuxt 3 support ends January 2026
5. **Future-Proofing**: Prepares for Nuxt 5 features (Vite Environment API)
6. **Existing Structure**: B2Connect's custom `srcDir: 'src'` can be maintained

### Recommended Timeline

1. **Week 1**: Update Node.js requirements, test in isolated branch
2. **Week 2**: Dependency updates, run codemods, fix TypeScript issues
3. **Week 3**: Full testing cycle, performance validation
4. **Week 4**: Staged rollout to development, then production

---

## References

- [Nuxt 4 Announcement Blog](https://nuxt.com/blog/v4)
- [Nuxt 4 Upgrade Guide](https://nuxt.com/docs/4.x/getting-started/upgrade)
- [Nuxt 4.0.0 Release Notes](https://github.com/nuxt/nuxt/releases/tag/v4.0.0)
- [Nuxt 4.2.x Changelog](https://github.com/nuxt/nuxt/releases)
- [@nuxtjs/i18n v10 Releases](https://github.com/nuxt-modules/i18n/releases)
- [Pinia Nuxt Integration](https://pinia.vuejs.org/ssr/nuxt.html)
- [Codemod Migration Recipe](https://app.codemod.com/registry)

---

**Maintained by**: @Architect  
**Last Updated**: 7. Januar 2026  
**Next Review**: Before migration execution
