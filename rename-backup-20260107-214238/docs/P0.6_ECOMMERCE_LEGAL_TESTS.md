# P0.6 E-Commerce Legal Compliance Test Suite

## Overview

This document contains 15 executable test cases covering all EU e-commerce legal compliance requirements for B2X store operations. Tests are written in Gherkin format for clarity and automated execution using Cucumber/BDD frameworks.

**Regulatory Coverage:**
- **PAngV**: Price transparency requirements
- **VVVG**: 14-day withdrawal/return rights
- **TMG**: Legal disclosure requirements
- **GDPR**: Privacy policy and data protection
- **AStV**: VAT handling and reverse charge for B2B
- **ODR-VO**: Alternative dispute resolution

**Test Execution:**
- Backend: xUnit/C# for unit and integration tests
- Frontend: Playwright for E2E tests
- API: Postman/Newman for API validation

---

## Feature: Price Transparency (PAngV Compliance)

### Scenario: B2C Product Price Display Shows Final Price Including VAT
```gherkin
Given a product with net price €100.00 and 19% VAT rate
When a B2C customer views the product detail page
Then the price should be displayed as "€119,00 inkl. MwSt"
And the price should NOT be displayed as "€100,00 + 19% MwSt"
And the display should be consistent across product listing, detail, cart, and checkout
```

### Scenario: Shipping Costs Displayed Before Checkout
```gherkin
Given a customer is in Germany with a €50 product in cart
When the customer views the cart page
Then shipping costs should be visible as "Versand: €4,99 nach Deutschland"
And shipping costs should update dynamically when customer changes country to Austria
And the total should recalculate automatically showing new shipping cost
```

### Scenario: Discounted Price Shows Original Price with Strikethrough
```gherkin
Given a product originally priced at €199.99 now discounted to €99.99
When a customer views the product
Then the original price should be displayed as "~~€199,99~~ €99,99"
And the discount percentage should be calculated and shown
And this should only display when there is an actual discount applied
```

---

## Feature: Withdrawal Rights (VVVG Compliance)

### Scenario: 14-Day Withdrawal Period Calculation from Delivery Date
```gherkin
Given an order was delivered on "2025-12-28"
When a customer requests withdrawal on "2026-01-05"
Then the withdrawal should be accepted (7 days remaining)
And the customer account should show "7 Tage Widerrufsfrist verbleibend"
```

### Scenario: Withdrawal Request Rejected After 14 Days
```gherkin
Given an order was delivered on "2025-12-28"
When a customer requests withdrawal on "2026-01-15"
Then the withdrawal should be rejected with error "Widerrufsfrist abgelaufen"
And the system should show "Widerrufsfrist: 17 Tage überschritten"
```

### Scenario: Return Form Generation and Download
```gherkin
Given a customer has a delivered order
When the customer requests a return form
Then a PDF return form should be generated containing:
  | Field              | Content |
  | Order Number       | [Order ID] |
  | Customer Address   | [Customer's return address] |
  | Withdrawal Statement | Pre-filled legal text |
And the form should be downloadable and printable
```

### Scenario: Automated Return Label Generation
```gherkin
Given a customer initiates a return within 14 days
When the return is approved
Then a return shipping label should be generated via DHL API
And a PDF with tracking number should be provided
And refund policy for return costs should be displayed
```

### Scenario: Refund Processing Within 14 Days of Withdrawal Request
```gherkin
Given a customer submitted a withdrawal request on "2026-01-05"
When the return is received and processed
Then the refund should be processed within 14 days (by "2026-01-19")
And the customer should receive a refund confirmation email
And the original payment method should be credited
```

---

## Feature: Legal Documents & Disclosure (TMG & GDPR Compliance)

### Scenario: Impressum Display and Accessibility
```gherkin
Given a shop has configured its legal information
When any customer visits any page
Then the footer should contain a link "Impressum"
And the Impressum page should display:
  | Required Information |
  | Company Name         |
  | Full Address         |
  | Email & Phone        |
  | Legal Form           |
  | VAT-ID/Tax Number    |
  | Responsible Person   |
And the page should be accessible without login
```

### Scenario: Privacy Policy GDPR Compliance
```gherkin
Given a shop has a GDPR-compliant privacy policy
When a customer views the privacy policy
Then it should contain sections for:
  | GDPR Requirement     |
  | Data Processing Purposes |
  | Legal Basis           |
  | Data Recipients       |
  | Retention Periods     |
  | User Rights           |
  | DPO Contact (if applicable) |
And the link should be visible in the footer on every page
```

### Scenario: Terms & Conditions Mandatory Acceptance at Checkout
```gherkin
Given a customer is at checkout with items in cart
When the customer attempts to complete the order
Then a checkbox "Ich akzeptiere die AGB" should be required
And the customer cannot proceed without checking it
And acceptance should be logged with timestamp, document version, and IP address
```

### Scenario: Legal Document Version Control and Audit Trail
```gherkin
Given a shop admin updates the Terms & Conditions
When customers check out after the update
Then the new version should be presented
And previous acceptances should be valid for existing orders
And an audit trail should record the change with timestamp and admin user
```

---

## Feature: VAT Handling & Invoicing (AStV Compliance)

### Scenario: B2C VAT Calculation and Invoice Breakdown
```gherkin
Given a German B2C customer orders a €100 standard product
When the order is calculated and invoice generated
Then VAT rate should be 19%
And final price should be €119.00 including VAT
And display should show "€119,00 inkl. 19% MwSt"
And invoice should show VAT breakdown:
  | Description | Net Price | VAT Rate | VAT Amount | Total |
  | Product     | €100.00   | 19%      | €19.00     | €119.00 |
And PDF should be encrypted with AES-256 and emailed
```

### Scenario: Invoice 10-Year Retention and Archival
```gherkin
Given invoices older than 10 years exist
When the daily archival job runs
Then old invoices should be moved to archive storage
And marked as IsArchived = true
And still accessible via customer account (read-only)
And retention should comply with German tax law § 257 HGB
```

---

## Test Execution Matrix

| Test Case | Type | Framework | File Location |
|-----------|------|-----------|---------------|
| Price Display | Unit/E2E | xUnit/Playwright | `/backend/tests/Catalog/PriceCalculationTests.cs` |
| Shipping Display | E2E | Playwright | `/frontend/tests/e2e/legal-compliance.spec.ts` |
| Discount Display | Unit/E2E | xUnit/Playwright | `/backend/tests/Catalog/PricingTests.cs` |
| Withdrawal Period | Unit/Integration | xUnit | `/backend/tests/Orders/ReturnTests.cs` |
| Withdrawal Rejection | Unit/Integration | xUnit | `/backend/tests/Orders/ReturnTests.cs` |
| Return Form | Integration | xUnit | `/backend/tests/Orders/ReturnTests.cs` |
| Return Label | Integration | xUnit | `/backend/tests/Orders/ReturnTests.cs` |
| Refund Processing | Integration | xUnit | `/backend/tests/Orders/RefundTests.cs` |
| Impressum Display | E2E | Playwright | `/frontend/tests/e2e/legal-compliance.spec.ts` |
| Privacy Policy | E2E | Playwright | `/frontend/tests/e2e/legal-compliance.spec.ts` |
| Terms Acceptance | E2E | Playwright | `/frontend/tests/e2e/checkout.spec.ts` |
| Version Control | Unit | xUnit | `/backend/tests/Catalog/LegalDocumentsTests.cs` |
| VAT Calculation & Invoice | Unit/Integration | xUnit | `/backend/tests/Catalog/InvoiceTests.cs` |
| VIES Validation | Integration | xUnit | `/backend/tests/Catalog/VatTests.cs` |
| Reverse Charge | Unit | xUnit | `/backend/tests/Catalog/VatTests.cs` |
| Invoice Archival | Integration | xUnit | `/backend/tests/Catalog/InvoiceTests.cs` |

## Test Data Requirements

### Sample Products
- Standard Product: €100 net, 19% VAT, Germany
- Reduced VAT Product: €50 net, 7% VAT, Germany
- Discounted Product: €200 original, €100 discounted

### Sample Customers
- B2C German: No VAT-ID
- B2B Austrian: Valid VAT-ID "ATU12345678"
- B2B Invalid: Invalid VAT-ID "DE999999999"

### Sample Orders
- Delivered Order: Delivery date 2025-12-28
- Recent Order: Delivery date current date - 3 days
- Old Order: Delivery date current date - 15 days

## Success Criteria

- All 15 test cases pass in CI/CD pipeline
- No legal compliance violations in production
- Invoice generation < 2 seconds
- VIES API calls < 5 seconds
- 100% test coverage for legal compliance logic
- Automated regression testing on legal changes

## Related Documentation

- [ISSUE_TEMPLATE_STORE_LEGAL_COMPLIANCE.md](../ISSUE_TEMPLATE_STORE_LEGAL_COMPLIANCE.md) - Implementation requirements
- [ECOMMERCE_LEGAL_OVERVIEW.md](ECOMMERCE_LEGAL_OVERVIEW.md) - Regulatory details
- [EU_SAAS_COMPLIANCE_IMPLEMENTATION_ROADMAP.md](EU_SAAS_COMPLIANCE_IMPLEMENTATION_ROADMAP.md) - Compliance roadmap