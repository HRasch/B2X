{
  // ============================================================================
  // Build tasks use -m:2 to limit parallel MSBuild workers (prevents file locks)
  // See: dotnet/sdk#9585, lessons.md "Parallel Build File Lock Conflicts"
  // ============================================================================
  "version": "2.0.0",
  "tasks": [
    {
      // Primary build task for Aspire - uses -m:2 to prevent race conditions
      "label": "build-apphost",
      "command": "dotnet",
      "type": "shell",
      "args": [
        "build",
        "${workspaceFolder}/src/backend/Infrastructure/Hosting/AppHost/B2X.AppHost.csproj",
        "-m:2"
      ],
      "problemMatcher": "$msCompile",
      "group": {
        "kind": "build",
        "isDefault": false
      },
      "presentation": {
        "echo": true,
        "reveal": "silent",
        "focus": false,
        "panel": "shared",
        "showReuseMessage": false,
        "clear": false
      }
    },
    {
      "label": "build-backend",
      "command": "dotnet",
      "type": "shell",
      "args": [
        "build",
        "${workspaceFolder}/B2X.slnx",
        "-m:2"
      ],
      "problemMatcher": "$msCompile",
      "group": {
        "kind": "build",
        "isDefault": true
      },
      "presentation": {
        "echo": true,
        "reveal": "silent",
        "focus": false,
        "panel": "shared",
        "showReuseMessage": false,
        "clear": false
      }
    },
    {
      "label": "test-backend",
      "command": "dotnet",
      "type": "shell",
      "args": [
        "test",
        "--solution",
        "${workspaceFolder}/B2X.slnx",
        "-v",
        "minimal"
      ],
      "problemMatcher": "$msCompile",
      "group": {
        "kind": "test",
        "isDefault": true
      },
      "presentation": {
        "echo": true,
        "reveal": "silent",
        "focus": false
      }
    },
    {
      "label": "coverage-report",
      "command": "dotnet",
      "type": "shell",
      "args": [
        "tool",
        "run",
        "reportgenerator",
        "-reports:reports/test-results/coverage/**/coverage.opencover.xml",
        "-targetdir:reports/test-results/coverage-report",
        "-reporttypes:Html;Cobertura;MarkdownSummary"
      ],
      "problemMatcher": "$msCompile",
      "group": "test",
      "presentation": {
        "echo": true,
        "reveal": "silent",
        "focus": false,
        "clear": false
      }
    },
    {
      "label": "generate-coverage",
      "command": "pwsh",
      "type": "shell",
      "args": [
        "-File",
        "${workspaceFolder}/scripts/generate-coverage.ps1"
      ],
      "problemMatcher": "$msCompile",
      "group": "test",
      "presentation": {
        "echo": true,
        "reveal": "always",
        "focus": false,
        "clear": false
      }
    },
    {
      "label": "test-catalog",
      "command": "dotnet",
      "type": "shell",
      "args": [
        "test",
        "${workspaceFolder}/src/backend/Store/Tests/Catalog/B2X.Catalog.Tests.csproj",
        "-v",
        "minimal"
      ],
      "problemMatcher": "$msCompile",
      "group": {
        "kind": "test"
      },
      "presentation": {
        "echo": true,
        "reveal": "silent",
        "focus": false,
        "panel": "shared",
        "showReuseMessage": false,
        "clear": false
      }
    },
    {
      "label": "test-cms",
      "command": "dotnet",
      "type": "shell",
      "args": [
        "test",
          "${workspaceFolder}/src/backend/Management/Tests/CMS/B2X.CMS.Tests.csproj",
        "-v",
        "minimal"
      ],
      "problemMatcher": "$msCompile",
      "group": {
        "kind": "test"
      },
      "presentation": {
        "echo": true,
        "reveal": "silent",
        "focus": false,
        "panel": "shared",
        "showReuseMessage": false,
        "clear": false
      }
    },
    {
      "label": "test-localization",
      "command": "dotnet",
      "type": "shell",
      "args": [
        "test",
        "${workspaceFolder}/src/backend/Shared/Domain/Localization/tests/B2X.Localization.Tests.csproj",
        "-v",
        "minimal"
      ],
      "problemMatcher": "$msCompile",
      "group": {
        "kind": "test"
      },
      "presentation": {
        "echo": true,
        "reveal": "silent",
        "focus": false
      }
    },
    {
      "label": "test-identity",
      "command": "dotnet",
      "type": "shell",
      "args": [
        "test",
          "${workspaceFolder}/src/backend/Shared/Domain/Identity/B2X.Identity.Tests.csproj",
        "-v",
        "minimal"
      ],
      "problemMatcher": "$msCompile",
      "group": {
        "kind": "test"
      },
      "presentation": {
        "echo": true,
        "reveal": "silent",
        "focus": false
      }
    },
    {
      "label": "test-search",
      "command": "dotnet",
      "type": "shell",
      "args": [
        "test",
        "${workspaceFolder}/src/backend/Shared/Infrastructure/Search/B2X.Shared.Search.Tests.csproj",
        "-v",
        "minimal"
      ],
      "problemMatcher": "$msCompile",
      "group": {
        "kind": "test"
      },
      "presentation": {
        "echo": true,
        "reveal": "silent",
        "focus": false
      }
    },
    {
      "label": "npm-install-frontend",
      "command": "npm",
      "type": "shell",
      "args": [
        "install"
      ],
      "cwd": "${workspaceFolder}/src/frontend/Store",
      "group": {
        "kind": "test"
      }
    },
    {
      "label": "dev-frontend",
      "command": "npm",
      "type": "shell",
      "args": [
        "run",
        "dev"
      ],
      "cwd": "${workspaceFolder}/src/frontend/Management",
      "isBackground": true,
      "problemMatcher": {
        "pattern": {
          "regexp": "^.*$",
          "file": 1,
          "location": 2,
          "message": 3
        },
        "background": {
          "activeOnStart": true,
          "beginsPattern": "^.*VITE.*ready.*",
          "endsPattern": "^.*listening on.*"
        }
      },
      "group": "build"
    },
    {
      "label": "lint-frontend",
      "command": "npm",
      "type": "shell",
      "args": [
        "run",
        "lint"
      ],
      "cwd": "${workspaceFolder}/src/frontend/Management",
      "group": "build"
    },
    {
      // Use 'aspire run' to start AppHost in a separate interactive window
      // WORKAROUND: VS Code terminal stdin redirection causes Aspire to exit immediately
      // See: dotnet/aspire#12242, GitHub Copilot session 2026-01-11
      // Solution: Start-Process spawns a new interactive PowerShell window
      "label": "backend-start",
      "type": "shell",
      "isBackground": true,
      "command": "Start-Process",
      "args": [
        "pwsh",
        "-ArgumentList",
        "'-NoExit', '-Command', 'cd ''${workspaceFolder}/src/backend/Infrastructure/Hosting/AppHost''; $env:Database__Provider=''inmemory''; $env:ASPIRE_ALLOW_UNSECURED_TRANSPORT=''true''; $env:DOTNET_DASHBOARD_UNSECURED_ALLOW_ANONYMOUS=''true''; aspire run --project B2X.AppHost.csproj'"
      ],
      "options": {
        "cwd": "${workspaceFolder}/src/backend/Infrastructure/Hosting/AppHost"
      },
      "problemMatcher": {
        "pattern": {
          "regexp": "^(.*)$",
          "file": 1
        },
        "background": {
          "activeOnStart": true,
          "beginsPattern": ".*B2X Application Host.*",
          "endsPattern": ".*✅ B2X Application Host initialized.*"
        }
      },
      "presentation": {
        "echo": true,
        "reveal": "silent",
        "group": "startup"
      }
    },
    {
      "label": "frontend-start",
      "type": "shell",
      "isBackground": false,
      "command": "npm",
      "args": [
        "run",
        "dev"
      ],
      "cwd": "${workspaceFolder}/src/frontend/Store",
      "problemMatcher": {
        "pattern": {
          "regexp": "^.*$",
          "line": 0
        },
        "background": {
          "activeOnStart": true,
          "beginsPattern": "^.*VITE.*",
          "endsPattern": "^.*listening.*5173.*"
        }
      },
      "presentation": {
        "echo": true,
        "reveal": "silent"
      }
    },
    {
      "label": "frontend-admin-start",
      "type": "shell",
      "isBackground": true,
      "command": "npm",
      "args": [
        "run",
        "dev"
      ],
      "cwd": "${workspaceFolder}/src/frontend/Admin",
      "problemMatcher": {
        "pattern": {
          "regexp": "^(.*)$",
          "file": 1
        },
        "background": {
          "activeOnStart": true,
          "beginsPattern": ".*VITE.*",
          "endsPattern": ".*Local:.*5174.*"
        }
      },
      "presentation": {
        "echo": true,
        "reveal": "always",
        "group": "startup"
      }
    },
    {
      "label": "open-aspire-dashboard",
      "type": "shell",
      "command": "start",
      "args": [
        "http://localhost:15500"
      ],
      "windows": {
        "command": "cmd",
        "args": [
          "/c",
          "start",
          "http://localhost:15500"
        ]
      },
      "presentation": {
        "echo": false,
        "reveal": "silent"
      },
      "runOptions": {
        "runOn": "folderOpen"
      }
    },
    {
      // Standalone Store Gateway (without Aspire) - for isolated debugging
      // Use 'backend-start' task instead for full stack with service coordination
      "label": "store-gateway-start",
      "type": "shell",
      "isBackground": true,
      "command": "dotnet",
      "args": [
        "run",
        "--project",
        "${workspaceFolder}/src/backend/Store/API/B2X.Store.csproj"
      ],
      "options": {
        "env": {
          "ASPNETCORE_ENVIRONMENT": "Development",
          "ASPNETCORE_URLS": "http://localhost:8000"
        }
      },
      "problemMatcher": {
        "pattern": {
          "regexp": "^(.*)$",
          "file": 1
        },
        "background": {
          "activeOnStart": true,
          "beginsPattern": ".*Now listening on.*",
          "endsPattern": ".*Application started.*"
        }
      },
      "presentation": {
        "echo": true,
        "reveal": "always",
        "group": "gateways"
      }
    },
    {
      // Standalone Admin Gateway (without Aspire) - for isolated debugging
      // Use 'backend-start' task instead for full stack with service coordination
      "label": "admin-gateway-start",
      "type": "shell",
      "isBackground": true,
      "command": "dotnet",
      "args": [
        "run",
        "--project",
        "${workspaceFolder}/src/backend/Admin/Gateway/B2X.Admin.csproj"
      ],
      "options": {
        "env": {
          "ASPNETCORE_ENVIRONMENT": "Development",
          "ASPNETCORE_URLS": "http://localhost:8080"
        }
      },
      "problemMatcher": {
        "pattern": {
          "regexp": "^(.*)$",
          "file": 1
        },
        "background": {
          "activeOnStart": true,
          "beginsPattern": ".*Now listening on.*",
          "endsPattern": ".*Application started.*"
        }
      },
      "presentation": {
        "echo": true,
        "reveal": "always",
        "group": "gateways"
      }
    },
    {
      "label": "service-health",
      "type": "shell",
      "command": "${workspaceFolder}/scripts/service-health.sh",
      "options": {
        "cwd": "${workspaceFolder}"
      },
      "presentation": {
        "echo": true,
        "reveal": "always",
        "focus": true,
        "panel": "shared"
      },
      "problemMatcher": [],
      "group": "test"
    },
    {
      "label": "service-health-watch",
      "type": "shell",
      "command": "${workspaceFolder}/scripts/service-health.sh --watch",
      "options": {
        "cwd": "${workspaceFolder}"
      },
      "isBackground": true,
      "presentation": {
        "echo": true,
        "reveal": "always",
        "focus": true,
        "panel": "dedicated"
      },
      "problemMatcher": []
    },
    {
      "label": "kill-all-services",
      "type": "shell",
      "command": "${workspaceFolder}/scripts/kill-all-services.sh",
      "options": {
        "cwd": "${workspaceFolder}"
      },
      "presentation": {
        "echo": true,
        "reveal": "always",
        "focus": false,
        "panel": "shared"
      },
      "problemMatcher": []
    },
    {
      "label": "restart-all-services",
      "dependsOrder": "sequence",
      "dependsOn": [
        "backend-start"
      ],
      "problemMatcher": []
    },
    {
      "label": "dotnet: build",
      "type": "shell",
      "command": "dotnet",
      "args": [
        "build",
        "${workspaceFolder}/src/backend/Infrastructure/Hosting/AppHost/B2X.AppHost.csproj"
      ],
      "problemMatcher": "$msCompile",
      "group": {
        "kind": "build",
        "isDefault": true
      }
    },
    {
      "label": "kill-then-build",
      "dependsOrder": "sequence",
      "dependsOn": [
        "dotnet: build"
      ],
      "problemMatcher": []
    },
    {
      "label": "npm-install-tenant",
      "command": "npm",
      "type": "shell",
      "args": [
        "install"
      ],
      "cwd": "${workspaceFolder}/src/frontend/Management",
      "group": "build"
    },
    {
      "label": "copilot-guardian-status",
      "type": "shell",
      "command": "${workspaceFolder}/scripts/copilot-guardian.sh",
      "args": ["status"],
      "group": "none",
      "presentation": {
        "reveal": "always",
        "panel": "new"
      }
    },
    {
      "label": "copilot-guardian-warn",
      "type": "shell",
      "command": "${workspaceFolder}/scripts/copilot-guardian.sh",
      "args": ["warn"],
      "group": "none",
      "presentation": {
        "reveal": "always",
        "panel": "new"
      }
    },
    {
      "label": "copilot-guardian-audit",
      "type": "shell",
      "command": "${workspaceFolder}/scripts/copilot-guardian.sh",
      "args": ["audit"],
      "group": "none",
      "presentation": {
        "reveal": "always",
        "panel": "new"
      }
    },
    {
      "label": "mcp-console-monitor",
      "type": "shell",
      "command": "echo",
      "args": [
        "MCP Console Logging integriert. Starte VS Code neu und prüfe Output Panel für MCP-Server-Logs."
      ],
      "group": "test",
      "presentation": {
        "echo": true,
        "reveal": "always",
        "focus": false
      }
    },
    {
      "label": "full-parallel-build",
      "dependsOn": [
        "build-backend",
        "npm-install-frontend",
        "npm-install-tenant"
      ],
      "dependsOrder": "parallel",
      "group": {
        "kind": "build"
      },
      "presentation": {
        "reveal": "silent",
        "panel": "shared"
      }
    },
    {
      "label": "test-all-parallel",
      "command": "dotnet",
      "type": "shell",
      "args": [
        "test",
        "--solution",
        "${workspaceFolder}/B2X.slnx",
        "-m",
        "--parallel",
        "-v",
        "minimal"
      ],
      "problemMatcher": "$msCompile",
      "group": {
        "kind": "test"
      },
      "presentation": {
        "echo": true,
        "reveal": "always",
        "focus": false
      }
    }
  ]
}
