// ============================================
// SCSS Functions - Bootstrap-style Color Math
// ============================================
// Usage: @use 'abstracts/functions' as fn;
//        color: fn.tint-color($primary, 20%);
// ============================================

@use 'sass:math';
@use 'sass:color';
@use 'sass:map';
@use 'sass:list';
@use 'sass:string';

// --------------------------------------------
// Color Functions
// --------------------------------------------

/// Tint a color: mix with white
/// @param {Color} $color - Base color
/// @param {Number} $weight - Percentage of white (0-100%)
/// @return {Color} Tinted color
@function tint-color($color, $weight) {
  @return color.mix(white, $color, $weight);
}

/// Shade a color: mix with black
/// @param {Color} $color - Base color
/// @param {Number} $weight - Percentage of black (0-100%)
/// @return {Color} Shaded color
@function shade-color($color, $weight) {
  @return color.mix(black, $color, $weight);
}

/// Shift a color: tint or shade based on lightness
/// @param {Color} $color - Base color
/// @param {Number} $weight - Positive = tint, Negative = shade
/// @return {Color} Shifted color
@function shift-color($color, $weight) {
  @if $weight > 0 {
    @return tint-color($color, $weight);
  } @else {
    @return shade-color($color, math.abs($weight));
  }
}

/// Get contrast color (black or white) based on luminance
/// @param {Color} $background - Background color
/// @param {Color} $dark - Dark text color (default: #212529)
/// @param {Color} $light - Light text color (default: #fff)
/// @param {Number} $threshold - Luminance threshold (default: 0.5)
/// @return {Color} Best contrast color
@function color-contrast($background, $dark: #212529, $light: #fff, $threshold: 0.5) {
  $luminance: luminance($background);
  @return if($luminance > $threshold, $dark, $light);
}

/// Calculate relative luminance
/// @param {Color} $color - Color to analyze
/// @return {Number} Luminance value 0-1
@function luminance($color) {
  $rgb: (
    'r': color.red($color),
    'g': color.green($color),
    'b': color.blue($color),
  );

  @each $channel, $value in $rgb {
    $value: math.div($value, 255);
    @if $value < 0.03928 {
      $value: math.div($value, 12.92);
    } @else {
      $value: math.pow(math.div($value + 0.055, 1.055), 2.4);
    }
    $rgb: map.set($rgb, $channel, $value);
  }

  @return 0.2126 * map.get($rgb, 'r') + 0.7152 * map.get($rgb, 'g') + 0.0722 * map.get($rgb, 'b');
}

/// Generate a full color palette from a base color
/// @param {Color} $base - Base color (500 level)
/// @return {Map} Color scale 50-950
@function generate-palette($base) {
  @return (
    50: tint-color($base, 95%),
    100: tint-color($base, 90%),
    200: tint-color($base, 75%),
    300: tint-color($base, 50%),
    400: tint-color($base, 25%),
    500: $base,
    600: shade-color($base, 15%),
    700: shade-color($base, 30%),
    800: shade-color($base, 45%),
    900: shade-color($base, 60%),
    950: shade-color($base, 80%)
  );
}

/// Get color from palette
/// @param {Map} $palette - Color palette map
/// @param {Number} $shade - Shade level (50-950)
/// @return {Color}
@function palette($palette, $shade: 500) {
  @return map.get($palette, $shade);
}

// --------------------------------------------
// Spacing Functions
// --------------------------------------------

/// Convert px to rem
/// @param {Number} $px - Pixel value
/// @param {Number} $base - Base font size (default: 16)
/// @return {Number} Rem value
@function to-rem($px, $base: 16) {
  @return math.div($px, $base) * 1rem;
}

/// Convert rem to px
/// @param {Number} $rem - Rem value
/// @param {Number} $base - Base font size (default: 16)
/// @return {Number} Pixel value
@function to-px($rem, $base: 16) {
  @return math.div($rem, 1rem) * $base * 1px;
}

/// Get spacing value from scale
/// @param {Number} $step - Scale step (0.5, 1, 1.5, 2, etc.)
/// @param {Number} $base - Base unit in px (default: 4)
/// @return {Number} Spacing in rem
@function spacing($step, $base: 4) {
  @return to-rem($step * $base);
}

// --------------------------------------------
// Typography Functions
// --------------------------------------------

/// Get fluid font size (clamp-based)
/// @param {Number} $min - Minimum size in px
/// @param {Number} $max - Maximum size in px
/// @param {Number} $vw-min - Viewport min in px (default: 375)
/// @param {Number} $vw-max - Viewport max in px (default: 1440)
/// @return {String} Clamp value
@function fluid-type($min, $max, $vw-min: 375, $vw-max: 1440) {
  $min-rem: to-rem($min);
  $max-rem: to-rem($max);
  $vw-range: $vw-max - $vw-min;
  $size-range: $max - $min;
  $slope: math.div($size-range, $vw-range);
  $intercept: $min - $slope * $vw-min;

  @return clamp(#{$min-rem}, #{to-rem($intercept)} + #{$slope * 100}vw, #{$max-rem});
}

/// Calculate line height ratio
/// @param {Number} $line-height - Line height in px
/// @param {Number} $font-size - Font size in px
/// @return {Number} Unitless ratio
@function line-height-ratio($line-height, $font-size) {
  @return math.div($line-height, $font-size);
}

// --------------------------------------------
// String Functions
// --------------------------------------------

/// Replace string
/// @param {String} $string - Source string
/// @param {String} $search - String to find
/// @param {String} $replace - Replacement string
/// @return {String}
@function str-replace($string, $search, $replace: '') {
  $index: string.index($string, $search);
  @if $index {
    @return string.slice($string, 1, $index - 1) + $replace +
      str-replace(string.slice($string, $index + string.length($search)), $search, $replace);
  }
  @return $string;
}

// --------------------------------------------
// Map Functions
// --------------------------------------------

/// Deep map merge
/// @param {Map} $map1 - Base map
/// @param {Map} $map2 - Override map
/// @return {Map} Merged map
@function map-deep-merge($map1, $map2) {
  $result: $map1;
  @each $key, $value in $map2 {
    @if type-of($value) == 'map' and type-of(map.get($result, $key)) == 'map' {
      $result: map.set($result, $key, map-deep-merge(map.get($result, $key), $value));
    } @else {
      $result: map.set($result, $key, $value);
    }
  }
  @return $result;
}

/// Get nested map value
/// @param {Map} $map - Source map
/// @param {List} $keys - Key path
/// @return {*} Value at path
@function map-deep-get($map, $keys...) {
  @each $key in $keys {
    @if type-of($map) != 'map' {
      @return null;
    }
    $map: map.get($map, $key);
  }
  @return $map;
}
