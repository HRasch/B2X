---
name: KB Sync Weekly

on:
  schedule:
    - cron: '0 6 * * 1'  # every Monday at 06:00 UTC
  workflow_dispatch:

jobs:
  kb-sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Ensure scripts are executable
        run: |
          chmod +x scripts/utilities/update-kb-sources.sh || true

      - name: Run KB sync script
        run: |
          scripts/utilities/update-kb-sources.sh

      - name: Find latest report
        id: find-report
        run: |
          REPORT=$(ls -t artifacts/kb-sync-report*.txt | head -n1 || true)
          if [ -z "$REPORT" ]; then
            echo "No report found" >&2
            echo "report_path=" >> $GITHUB_OUTPUT
            echo "report_body=" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "report_path=$REPORT" >> $GITHUB_OUTPUT
          echo "report_body<<'EOF'" >> $GITHUB_OUTPUT
          cat "$REPORT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload report artifact
        if: steps.find-report.outputs.report_path != ''
        uses: actions/upload-artifact@v6
        with:
          name: kb-sync-report
          path: ${{ steps.find-report.outputs.report_path }}

      - name: Create KB Sync Issue
        if: steps.find-report.outputs.report_path != ''
        uses: peter-evans/create-issue@v5
        with:
          title: KB Sync Report â€” ${{ github.run_number }}
          body: ${{ steps.find-report.outputs.report_body }}
          labels: kb-sync,automation
