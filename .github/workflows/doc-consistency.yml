name: Documentation Consistency Check

on:
  push:
    paths:
      - '.ai/**'
      - '.github/agents/**'
      - '.github/prompts/**'
      - '.github/instructions/**'
      - 'docs/**'
      - '.github/workflows/doc-consistency.yml'
  pull_request:
    paths:
      - '.ai/**'
      - '.github/agents/**'
      - '.github/prompts/**'
      - '.github/instructions/**'
      - 'docs/**'
  schedule:
    # Weekly full audit - Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      report_format:
        description: 'Report format (Console, Markdown, JSON)'
        required: false
        default: 'Markdown'

jobs:
  validate-documentation:
    name: Validate Documentation Consistency
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for change detection

      - name: Setup PowerShell
        shell: pwsh
        run: |
          Write-Host "PowerShell version: $($PSVersionTable.PSVersion)"

      - name: Run consistency validation
        id: validate
        shell: pwsh
        run: |
          $format = "${{ github.event.inputs.report_format }}"
          if ([string]::IsNullOrEmpty($format)) { $format = "Markdown" }
          
          # Run validation script
          $output = & ./scripts/validation/validate-doc-consistency.ps1 `
            -Path $env:GITHUB_WORKSPACE `
            -ReportFormat $format `
            -FailOnError
          
          # Save output for PR comment
          if ($format -eq "Markdown") {
            $output | Out-File -FilePath "doc-consistency-report.md" -Encoding utf8
          }
          
          Write-Output $output
        continue-on-error: true

      - name: Upload report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: doc-consistency-report
          path: doc-consistency-report.md
          retention-days: 30

      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let body = '## ðŸ“š Documentation Consistency Check\n\n';
            
            try {
              const report = fs.readFileSync('doc-consistency-report.md', 'utf8');
              body += report;
            } catch (e) {
              body += 'âš ï¸ Could not generate detailed report. Check workflow logs.';
            }
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Documentation Consistency Check')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Check validation result
        if: steps.validate.outcome == 'failure'
        run: |
          echo "::error::Documentation consistency check failed. See report for details."
          exit 1

  create-issues-for-stale-docs:
    name: Create Issues for Stale Documents
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    needs: validate-documentation
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run validation and get JSON report
        id: validate
        shell: pwsh
        run: |
          $output = & ./scripts/validation/validate-doc-consistency.ps1 `
            -Path $env:GITHUB_WORKSPACE `
            -ReportFormat JSON
          
          $output | Out-File -FilePath "report.json" -Encoding utf8

      - name: Create issues for stale documents
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            try {
              const report = JSON.parse(fs.readFileSync('report.json', 'utf8'));
              
              const staleResults = report.results.filter(r => 
                r.category === 'Stale' && r.type === 'Error'
              );
              
              for (const result of staleResults) {
                const title = `ðŸ“š Stale Documentation: ${result.file}`;
                
                // Check if issue already exists
                const { data: existingIssues } = await github.rest.issues.listForRepo({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'open',
                  labels: 'doc-consistency-review'
                });
                
                const exists = existingIssues.some(i => i.title === title);
                
                if (!exists) {
                  await github.rest.issues.create({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    title: title,
                    body: `## Documentation Review Required\n\n**File**: \`${result.file}\`\n**Issue**: ${result.message}\n\n### Action Required\n\n1. Review the document and its source references\n2. Update content if needed\n3. Update \`last-verified\` date\n4. Close this issue\n\n---\n*Auto-generated by doc-consistency workflow*`,
                    labels: ['doc-consistency-review', 'documentation']
                  });
                  
                  console.log(`Created issue for: ${result.file}`);
                }
              }
            } catch (e) {
              console.log('No stale documents or error parsing report:', e.message);
            }
