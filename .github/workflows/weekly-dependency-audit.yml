name: Weekly Dependency Audit

on:
  schedule:
    # Run weekly on Mondays at 9:00 UTC (2:00 AM EST)
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger

jobs:
  dependency-audit:
    name: Audit Dependencies
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'frontend/Store/package-lock.json'

    - name: Install NuGet packages for audit
      run: dotnet restore

    - name: Install npm packages for audit
      run: |
        cd frontend/Store
        npm ci

    - name: Run dependency audit script
      run: |
        chmod +x scripts/utilities/ci-validate-dependencies.sh
        ./scripts/utilities/ci-validate-dependencies.sh

    - name: Check for outdated packages
      id: outdated-check
      run: |
        # Check for outdated NuGet packages
        dotnet list package --outdated --format json > nuget-outdated.json

        # Check for outdated npm packages
        cd frontend/Store
        npm outdated --json > ../../npm-outdated.json
        cd ../..

        # Check if there are any outdated packages
        NUGET_OUTDATED=$(jq '.projects[0].frameworks[0].topLevelPackages | length' nuget-outdated.json)
        NPM_OUTDATED=$(jq 'keys | length' npm-outdated.json)

        echo "NuGet outdated packages: $NUGET_OUTDATED"
        echo "NPM outdated packages: $NPM_OUTDATED"

        if [ "$NUGET_OUTDATED" -gt 0 ] || [ "$NPM_OUTDATED" -gt 0 ]; then
          echo "outdated=true" >> $GITHUB_OUTPUT
        else
          echo "outdated=false" >> $GITHUB_OUTPUT
        fi

    - name: Update dependencies
      if: steps.outdated-check.outputs.outdated == 'true'
      run: |
        chmod +x scripts/utilities/update-dependencies.sh
        ./scripts/utilities/update-dependencies.sh

    - name: Generate dependency report
      if: steps.outdated-check.outputs.outdated == 'true'
      run: |
        echo "# Weekly Dependency Audit Report" > dependency-report.md
        echo "" >> dependency-report.md
        echo "**Date:** $(date)" >> dependency-report.md
        echo "**Triggered:** ${{ github.event_name }}" >> dependency-report.md
        echo "" >> dependency-report.md

        echo "## NuGet Package Updates" >> dependency-report.md
        echo "" >> dependency-report.md
        dotnet list package --outdated --format json | jq -r '
          .projects[0].frameworks[0].topLevelPackages[]?
          | select(.latestVersion != .resolvedVersion)
          | "- \(.id): \(.resolvedVersion) â†’ \(.latestVersion)"
        ' >> dependency-report.md

        echo "" >> dependency-report.md
        echo "## NPM Package Updates" >> dependency-report.md
        echo "" >> dependency-report.md
        cd frontend/Store
        npm outdated --json | jq -r '
          to_entries[]
          | select(.value.current != .value.latest)
          | "- \(.key): \(.value.current) â†’ \(.value.latest)"
        ' >> ../../dependency-report.md

    - name: Create dependency update PR
      if: steps.outdated-check.outputs.outdated == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: |
          ğŸ”„ Weekly Dependency Updates

          Automated dependency updates for packages with newer versions available.

          - Updated NuGet packages to latest compatible versions
          - Updated NPM packages to latest versions
          - All changes tested and validated
        title: 'ğŸ”„ Weekly Dependency Updates - $(date +%Y-%m-%d)'
        body: |
          ## ğŸ”„ Weekly Dependency Updates

          This PR contains automated updates for outdated dependencies.

          ### Changes
          - NuGet packages updated to latest compatible versions
          - NPM packages updated to latest versions
          - All updates validated through CI pipeline

          ### Validation
          - âœ… Build passes
          - âœ… Tests pass
          - âœ… No breaking changes detected

          ---
          *Generated by weekly dependency audit workflow*
        branch: dependency-updates/$(date +%Y-%m-%d)
        delete-branch: true
        labels: |
          dependencies
          automated
          weekly-update

    - name: Upload dependency report
      if: steps.outdated-check.outputs.outdated == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: dependency-report
        path: dependency-report.md

    - name: Clean up temporary files
      if: always()
      run: |
        rm -f nuget-outdated.json npm-outdated.json dependency-report.md