name: Security Scans (CodeQL + Snyk)

on:
  schedule:
    - cron: '0 4 * * 0' # weekly on Sunday at 04:00 UTC
  workflow_dispatch:

jobs:
  codeql-analysis:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: ['csharp', 'javascript']
      - name: Autobuild
        uses: github/codeql-action/autobuild@v2
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

  snyk-scan:
    runs-on: ubuntu-latest
    needs: codeql-analysis
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies (frontend)
        run: |
          if [ -d frontend/Store ]; then
            cd frontend/Store
            npm ci --silent || true
          fi
          if [ -d frontend/Admin ]; then
            cd ../Admin
            npm ci --silent || true
          fi
      - name: Run Snyk test
        uses: snyk/actions/snyk@master
        with:
          command: test
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
