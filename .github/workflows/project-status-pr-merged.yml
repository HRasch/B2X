name: Auto-Update Project Status (PR Merged)

on:
  pull_request:
    types: [closed]

permissions:
  contents: read
  pull-requests: read

jobs:
  update-project-status-merged:
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.merged == true &&
      github.event.pull_request.body &&
      contains(github.event.pull_request.body, 'Closes #')
    
    steps:
      - name: Extract Issue Number
        id: extract_issue
        run: |
          BODY="${{ github.event.pull_request.body }}"
          ISSUE_NUM=$(echo "$BODY" | grep -oP '(?:Closes|closes|close|Close) #\K\d+' | head -1)
          if [ -z "$ISSUE_NUM" ]; then
            ISSUE_NUM=$(echo "$BODY" | grep -oP '#\K\d+' | head -1)
          fi
          echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT
          echo "✅ PR merged for issue: #$ISSUE_NUM"
      
      - name: Get Project Item ID
        id: get_item
        run: |
          QUERY='query {
            repository(owner: "HRasch", name: "B2Connect") {
              issue(number: ${{ steps.extract_issue.outputs.issue_number }}) {
                projectItems(first: 10) {
                  nodes {
                    project {
                      id
                    }
                    id
                  }
                }
              }
            }
          }'
          
          RESULT=$(gh api graphql -f query="$QUERY" --jq '.data.repository.issue.projectItems.nodes[0]')
          ITEM_ID=$(echo "$RESULT" | jq -r '.id')
          PROJECT_ID=$(echo "$RESULT" | jq -r '.project.id')
          
          echo "item_id=$ITEM_ID" >> $GITHUB_OUTPUT
          echo "project_id=$PROJECT_ID" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update Status to "Done"
        if: steps.get_item.outputs.item_id != 'null'
        run: |
          gh api graphql -f query='
          mutation {
            updateProjectV2ItemFieldValue(input: {
              projectId: "${{ steps.get_item.outputs.project_id }}"
              itemId: "${{ steps.get_item.outputs.item_id }}"
              fieldId: "PVTSSF_lAHOAWN9Gs4BLeEdzg7CLQI"
              value: {singleSelectOptionId: "98236657"}
            }) {
              projectV2Item {
                id
              }
            }
          }'
          echo "✅ Status updated to 'Done' for issue #${{ steps.extract_issue.outputs.issue_number }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Close Issue
        run: |
          gh issue close ${{ steps.extract_issue.outputs.issue_number }} \
            --repo HRasch/B2Connect \
            --comment "✅ Closed automatically - PR merged"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
