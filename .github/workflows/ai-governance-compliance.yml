name: AI Governance Compliance Check

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger
  push:
    paths:
      - '.github/instructions/ai-governance.instructions.md'
      - '.github/agents/*.agent.md'
      - '.github/instructions/*.instructions.md'
      - 'scripts/monitor-ai-governance.sh'

jobs:
  compliance-check:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up bash
      run: chmod +x scripts/monitor-ai-governance.sh

    - name: Run AI Governance Compliance Check
      id: compliance
      run: |
        echo "## AI Governance Compliance Report" >> $GITHUB_STEP_SUMMARY
        echo "Generated: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Run the monitoring script and capture output
        ./scripts/monitor-ai-governance.sh >> $GITHUB_STEP_SUMMARY

    - name: Check compliance thresholds
      run: |
        # Extract compliance rates from the script output
        AGENT_COMPLIANCE=$(./scripts/monitor-ai-governance.sh agents | grep "Compliance rate:" | awk '{print $3}' | tr -d '%')
        INSTRUCTION_COMPLIANCE=$(./scripts/monitor-ai-governance.sh instructions | grep "Compliance rate:" | awk '{print $3}' | tr -d '%')

        echo "Agent compliance: $AGENT_COMPLIANCE%"
        echo "Instruction compliance: $INSTRUCTION_COMPLIANCE%"

        # Check if compliance is above 95%
        if [ "$AGENT_COMPLIANCE" -lt 95 ] || [ "$INSTRUCTION_COMPLIANCE" -lt 95 ]; then
          echo "Compliance below threshold - creating issue"
          exit 1
        else
          echo "All compliance checks passed"
        fi

    - name: Create compliance issue (if failed)
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const title = `AI Governance Compliance Alert - ${new Date().toISOString().split('T')[0]}`
          const body = `
          ## ðŸš¨ AI Governance Compliance Issue

          The automated compliance check has detected compliance rates below the required threshold (>95%).

          ### Details
          - **Date**: ${new Date().toISOString()}
          - **Workflow Run**: ${context.payload.workflow_run?.html_url || 'Manual trigger'}
          - **Repository**: ${context.repo.owner}/${context.repo.repo}

          ### Required Actions
          1. Review the compliance report in the workflow logs
          2. Update agent files and instruction files to include governance references
          3. Re-run the compliance check
          4. Close this issue once compliance is restored

          ### Governance Requirements
          All agents and instruction files must reference the AI governance rules from:
          - [.github/instructions/ai-governance.instructions.md](.github/instructions/ai-governance.instructions.md)

          ---
          *This issue was automatically created by the AI Governance Compliance workflow.*
          `

          // Check if an open issue with this title already exists
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['ai-governance', 'compliance'],
            state: 'open'
          })

          const existingIssue = issues.data.find(issue => issue.title.includes('AI Governance Compliance Alert'))

          if (!existingIssue) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['ai-governance', 'compliance', 'automated']
            })
          } else {
            // Update existing issue with new comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssue.number,
              body: `## Compliance Check Failed Again\n\nDate: ${new Date().toISOString()}\n\nPlease review and fix compliance issues.`
            })
          }

    - name: Notify on success
      if: success()
      run: |
        echo "âœ… AI Governance compliance check passed"
        echo "All agents and instruction files are compliant with governance requirements."