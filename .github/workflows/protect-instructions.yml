# =============================================================================
# Instruction Protection Pipeline
# =============================================================================
# Validates changes to agent system files per GL-008 Governance Policies
# DocID: Related to ADR-039
# =============================================================================

name: ðŸ”’ Instruction Protection

on:
  pull_request:
    paths:
      - '.github/agents/**'
      - '.github/instructions/**'
      - '.github/prompts/**'
      - '.github/copilot-instructions.md'
      - '.vscode/mcp.json'
    branches:
      - main
      - develop

permissions:
  contents: read
  pull-requests: write

jobs:
  # ===========================================================================
  # Validate Schema & Structure
  # ===========================================================================
  validate-structure:
    name: ðŸ“‹ Validate Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check Agent File Structure
        run: |
          echo "ðŸ” Validating agent file structure..."
          
          # Check all agent files have required frontmatter
          for file in .github/agents/*.agent.md; do
            if [ -f "$file" ]; then
              if ! head -1 "$file" | grep -q "^---"; then
                echo "âŒ Missing frontmatter in: $file"
                exit 1
              fi
              echo "âœ… $file has valid structure"
            fi
          done
          
          # Check instruction files have applyTo
          for file in .github/instructions/*.instructions.md; do
            if [ -f "$file" ]; then
              if ! grep -q "applyTo:" "$file"; then
                echo "âŒ Missing applyTo in: $file"
                exit 1
              fi
              echo "âœ… $file has applyTo defined"
            fi
          done
          
          echo "âœ… All files have valid structure"

      - name: Check Required Sections in Agents
        run: |
          echo "ðŸ” Checking agent required sections..."
          
          REQUIRED_SECTIONS=("Role" "Responsibilities" "Permissions")
          
          for file in .github/agents/*.agent.md; do
            if [ -f "$file" ]; then
              for section in "${REQUIRED_SECTIONS[@]}"; do
                if ! grep -qi "## .*$section\|# .*$section" "$file"; then
                  echo "âš ï¸ Warning: '$section' section might be missing in $file"
                fi
              done
            fi
          done
          
          echo "âœ… Section check complete"

  # ===========================================================================
  # Security Validation
  # ===========================================================================
  security-check:
    name: ðŸ” Security Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for Sensitive Patterns
        run: |
          echo "ðŸ” Scanning for sensitive patterns..."
          
          SENSITIVE_PATTERNS=(
            "password"
            "secret"
            "api[_-]?key"
            "token"
            "credential"
            "private[_-]?key"
          )
          
          FILES=$(find .github/agents .github/instructions .github/prompts -name "*.md" 2>/dev/null || true)
          
          FOUND_ISSUES=0
          for file in $FILES; do
            for pattern in "${SENSITIVE_PATTERNS[@]}"; do
              if grep -iE "$pattern\s*[:=]" "$file" 2>/dev/null; then
                echo "âš ï¸ Potential sensitive data in $file (pattern: $pattern)"
                FOUND_ISSUES=1
              fi
            done
          done
          
          if [ $FOUND_ISSUES -eq 1 ]; then
            echo "âŒ Security review required - potential sensitive data detected"
            exit 1
          fi
          
          echo "âœ… No sensitive patterns detected"

      - name: Check for Dangerous Permissions
        run: |
          echo "ðŸ” Checking for dangerous permission patterns..."
          
          DANGEROUS_PATTERNS=(
            "sudo"
            "rm -rf"
            "chmod 777"
            "eval\("
            "exec\("
          )
          
          FILES=$(find .github/agents .github/instructions .github/prompts -name "*.md" 2>/dev/null || true)
          
          for file in $FILES; do
            for pattern in "${DANGEROUS_PATTERNS[@]}"; do
              if grep -iE "$pattern" "$file" 2>/dev/null; then
                echo "âš ï¸ Dangerous pattern '$pattern' found in $file"
              fi
            done
          done
          
          echo "âœ… Permission check complete"

  # ===========================================================================
  # Checksum Validation
  # ===========================================================================
  checksum-audit:
    name: ðŸ“Š Checksum Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Generate Change Report
        run: |
          echo "ðŸ“‹ Generating change report..."
          
          echo "## ðŸ”’ Protected Files Modified" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following protected instruction files were modified:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          git diff --name-only HEAD~1 HEAD -- \
            '.github/agents/' \
            '.github/instructions/' \
            '.github/prompts/' \
            '.github/copilot-instructions.md' \
            '.vscode/mcp.json' | while read file; do
              echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
              
              # Generate checksum for audit trail
              if [ -f "$file" ]; then
                CHECKSUM=$(sha256sum "$file" | cut -d' ' -f1)
                echo "  - SHA256: \`${CHECKSUM:0:16}...\`" >> $GITHUB_STEP_SUMMARY
              fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš ï¸ Review Requirements" >> $GITHUB_STEP_SUMMARY
          echo "- Per [GL-008]: These files require @CopilotExpert approval" >> $GITHUB_STEP_SUMMARY
          echo "- Policy changes require additional @SARAH approval" >> $GITHUB_STEP_SUMMARY

      - name: Create Audit Log Entry
        run: |
          echo "ðŸ“ Audit log entry:"
          echo "Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "PR: ${{ github.event.pull_request.number }}"
          echo "Author: ${{ github.event.pull_request.user.login }}"
          echo "Files changed:"
          git diff --name-only HEAD~1 HEAD -- \
            '.github/agents/' \
            '.github/instructions/' \
            '.github/prompts/'

  # ===========================================================================
  # Governance Compliance
  # ===========================================================================
  governance-check:
    name: ðŸ›ï¸ Governance Compliance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check Document Registry Updates
        run: |
          echo "ðŸ” Checking if Document Registry needs update..."
          
          # Check if new agent files were added
          NEW_AGENTS=$(git diff --name-only --diff-filter=A HEAD~1 HEAD -- '.github/agents/*.agent.md' 2>/dev/null || true)
          
          if [ -n "$NEW_AGENTS" ]; then
            echo "âš ï¸ New agent files detected:"
            echo "$NEW_AGENTS"
            echo ""
            echo "ðŸ“‹ Remember to update .ai/DOCUMENT_REGISTRY.md with new AGT-* entries"
            echo "::warning::New agent files require Document Registry update"
          fi
          
          # Check if new prompt files were added
          NEW_PROMPTS=$(git diff --name-only --diff-filter=A HEAD~1 HEAD -- '.github/prompts/*.prompt.md' 2>/dev/null || true)
          
          if [ -n "$NEW_PROMPTS" ]; then
            echo "âš ï¸ New prompt files detected:"
            echo "$NEW_PROMPTS"
            echo ""
            echo "ðŸ“‹ Remember to update .ai/DOCUMENT_REGISTRY.md with new PRM-* entries"
            echo "::warning::New prompt files require Document Registry update"
          fi

      - name: Verify CODEOWNERS Alignment
        run: |
          echo "ðŸ” Verifying CODEOWNERS coverage..."
          
          # Check that all agent system paths are in CODEOWNERS
          if [ -f ".github/CODEOWNERS" ]; then
            if ! grep -q ".github/agents/" .github/CODEOWNERS; then
              echo "âŒ .github/agents/ not covered in CODEOWNERS"
              exit 1
            fi
            if ! grep -q ".github/instructions/" .github/CODEOWNERS; then
              echo "âŒ .github/instructions/ not covered in CODEOWNERS"
              exit 1
            fi
            if ! grep -q ".github/prompts/" .github/CODEOWNERS; then
              echo "âŒ .github/prompts/ not covered in CODEOWNERS"
              exit 1
            fi
            echo "âœ… All protected paths are covered in CODEOWNERS"
          else
            echo "âš ï¸ CODEOWNERS file not found"
          fi

  # ===========================================================================
  # Summary
  # ===========================================================================
  summary:
    name: ðŸ“Š Protection Summary
    runs-on: ubuntu-latest
    needs: [validate-structure, security-check, checksum-audit, governance-check]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸ”’ Instruction Protection Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Structure Validation | ${{ needs.validate-structure.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Check | ${{ needs.security-check.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Checksum Audit | ${{ needs.checksum-audit.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Governance Compliance | ${{ needs.governance-check.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“– Reference: [GL-008] Governance Policies, [ADR-039] Instruction Protection" >> $GITHUB_STEP_SUMMARY
