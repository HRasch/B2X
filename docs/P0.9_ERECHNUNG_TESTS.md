# üìÑ P0.9: E-Rechnung (ERechnungsverordnung) - Test Specifications

**Regulatory Driver:** ERechnungsverordnung (E-Invoicing Regulation)  
**Standard:** ZUGFeRD 3.0, UBL 2.3 (EU-Standard)  
**Deadline:** 2025 (Pflicht f√ºr B2B Rechnungen ab ‚Ç¨100K Umsatz)  
**Penalties:** ‚Ç¨5.000-50.000 + Reputationsschaden  
**Effort:** 40 hours (1.25 weeks, 1.5 FTE)

---

## Overview

Elektronische Rechnungen (E-Rechnung) m√ºssen standardisiert sein:
- ‚úÖ XML-Format (ZUGFeRD oder UBL)
- ‚úÖ Digitale Signatur (optional aber empfohlen)
- ‚úÖ Maschinenlesbar (nicht nur PDF)
- ‚úÖ Archivierbar (10 Jahre)
- ‚úÖ Integrationsf√§hig (mit ERP-Systemen)

**B2Connect Impact:**
- B2B Rechnungen m√ºssen ZUGFeRD 3.0 oder UBL 2.3 sein
- B2C optional (PDF reicht)
- Admin muss E-Rechnungen importieren k√∂nnen (SAP, NetSuite, etc.)
- Rechnungen m√ºssen validierbar sein

---

## 10 Test Cases f√ºr E-Rechnung Compliance

### Test Group 1: Invoice Generation (3 Tests)

#### Test 1.1: B2B Invoice Generated as Valid ZUGFeRD 3.0 XML
```csharp
[Fact]
public async Task InvoiceGeneration_CreateZUGFERD3_ValidXML_ForB2BOrders()
{
    // Arrange
    var order = new Order
    {
        Id = Guid.NewGuid(),
        TenantId = Guid.NewGuid(),
        BillingPartyType = "B2B", // Important: B2B only
        InvoiceNumber = "INV-2025-001",
        InvoiceDate = DateTime.Now,
        DueDate = DateTime.Now.AddDays(30),
        Items = new[] {
            new OrderItem { Sku = "PROD-001", Name = "Product", Qty = 2, Price = 100m, VatRate = 0.19m }
        }
    };
    
    // Act - Generate ZUGFeRD XML
    var xmlContent = await _invoiceService.GenerateZUGFeRDAsync(order);
    
    // Assert - Valid XML structure
    var xdoc = XDocument.Parse(xmlContent);
    Assert.NotNull(xdoc);
    
    // Required ZUGFeRD elements
    var root = xdoc.Root;
    Assert.Equal("rsm:CrossIndustryInvoice", root.Name.LocalName);
    
    var invoiceNumber = root.Descendants()
        .FirstOrDefault(x => x.Name.LocalName == "ID")?
        .Value;
    Assert.Equal("INV-2025-001", invoiceNumber);
    
    // Validate line items
    var lineItems = root.Descendants()
        .Where(x => x.Name.LocalName == "IncludedSupplyChainTradeLineItem")
        .Count();
    
    Assert.Equal(1, lineItems);
    
    // Validate VAT calculation
    var taxTotal = root.Descendants()
        .FirstOrDefault(x => x.Name.LocalName == "CalculatedAmount")?
        .Value;
    
    var expectedVat = order.Items.Sum(i => i.Price * i.Qty * (decimal)i.VatRate);
    Assert.Equal(expectedVat.ToString("F2"), taxTotal?.Trim());
}
```

**Focus:** Valid ZUGFeRD 3.0 XML structure, all required fields, VAT calculated correctly  
**Standard Reference:** ZUGFeRD 3.0 Core Specification  
**Acceptance:** XML validates against ZUGFeRD schema, parseable by ERPConnect, WinSoft, etc.

---

#### Test 1.2: Invoice Also Provided as PDF with Embedded XML (Hybrid Format)
```csharp
[Fact]
public async Task Invoice_GeneratedAsHybridPDF_WithEmbeddedZUGFERDXML()
{
    // Arrange
    var order = await CreateB2BOrderAsync();
    
    // Act - Generate hybrid invoice
    var pdfBytes = await _invoiceService.GenerateHybridPDFAsync(order);
    
    // Assert - PDF has embedded ZUGFeRD XML
    using (var doc = PdfDocument.Open(pdfBytes))
    {
        // Check for embedded XML file
        var files = doc.DocumentInformation?.EmbeddedFiles;
        Assert.NotNull(files);
        
        var zugferdFile = files.FirstOrDefault(f => 
            f.Name.Contains("zugferd") || f.Name.Contains("factur"));
        Assert.NotNull(zugferdFile, "PDF must contain embedded ZUGFeRD XML");
        
        // Extract and validate embedded XML
        var xmlBytes = zugferdFile.GetData();
        var xmlContent = Encoding.UTF8.GetString(xmlBytes);
        
        var xdoc = XDocument.Parse(xmlContent);
        Assert.NotNull(xdoc);
    }
    
    // User can view as PDF, but also extract XML for ERP import
    Assert.True(pdfBytes.Length > 5000, "PDF file size reasonable");
}
```

**Focus:** Hybrid PDF with embedded ZUGFeRD XML (best practice)  
**Standard Reference:** ZUGFeRD Extension f√ºr PDF  
**Acceptance:** PDF human-readable, XML machine-readable, both in one file

---

#### Test 1.3: UBL 2.3 Alternative Format Also Supported
```csharp
[Fact]
public async Task InvoiceGeneration_AlsoSupportsUBL2_3_Format()
{
    // Arrange
    var order = await CreateB2BOrderAsync();
    
    // Act - Generate UBL format (alternative to ZUGFeRD)
    var ublXml = await _invoiceService.GenerateUBLAsync(order);
    
    // Assert - Valid UBL structure
    var xdoc = XDocument.Parse(ublXml);
    
    var root = xdoc.Root;
    Assert.Equal("Invoice", root.Name.LocalName); // UBL root element
    
    // Required UBL elements
    var invoiceId = root.Descendants()
        .FirstOrDefault(x => x.Name.LocalName == "ID")?
        .Value;
    Assert.NotEmpty(invoiceId);
    
    // UBL uses different namespace
    Assert.Contains("ubl", root.Name.NamespaceName.ToLower());
}
```

**Focus:** Support UBL 2.3 as alternative to ZUGFeRD  
**Standard Reference:** UBL 2.3 (EU Standard)  
**Acceptance:** Validates against UBL schema, importable by alternative ERPs

---

### Test Group 2: Digital Signature (2 Tests)

#### Test 2.1: Optional - Invoice Can Be Digitally Signed (XAdES)
```csharp
[Fact]
public async Task DigitalSignature_CanSignInvoiceXML_WithXAdES()
{
    // Arrange
    var order = await CreateB2BOrderAsync();
    var xmlContent = await _invoiceService.GenerateZUGFeRDAsync(order);
    
    var cert = new X509Certificate2(_certPath, _certPassword);
    
    // Act - Sign XML with XAdES-BES (optional but recommended)
    var signedXml = await _signingService.SignXmlAsync(xmlContent, cert, SignatureLevel.XAdES_BES);
    
    // Assert - Valid signed XML
    var xdoc = XDocument.Parse(signedXml);
    
    // Check for signature element
    var signature = xdoc.Descendants()
        .FirstOrDefault(x => x.Name.LocalName == "Signature");
    
    Assert.NotNull(signature);
    
    // Signature includes timestamp
    var timestamp = signature.Descendants()
        .FirstOrDefault(x => x.Name.LocalName == "SignatureTimeStamp");
    
    Assert.NotNull(timestamp, "Signature should include timestamp");
    
    // Can be verified
    var isValid = await _signingService.VerifySignatureAsync(signedXml);
    Assert.True(isValid);
}
```

**Focus:** Optional digital signature with XAdES-BES  
**Standard Reference:** XAdES Technical Specification  
**Acceptance:** Valid signature, timestamp, verifiable with standard tools

---

#### Test 2.2: Signature Verification Tool Available
```csharp
[Fact]
public async Task SignatureVerification_AvailableInAdminPanel()
{
    // Arrange
    var adminPage = await _browser.LoginAsAdminAsync();
    var signedInvoiceId = await CreateSignedInvoiceAsync();
    
    // Act - Navigate to invoice verification
    await adminPage.GoToAsync($"https://localhost:5174/invoices/{signedInvoiceId}/verify");
    
    // Assert - Verification info displayed
    var signatureStatus = await adminPage.TextContentAsync("[data-testid='signature-status']");
    var signatureDate = await adminPage.TextContentAsync("[data-testid='signature-date']");
    var signerInfo = await adminPage.TextContentAsync("[data-testid='signer-info']");
    
    Assert.Contains("Valid", signatureStatus);
    Assert.NotEmpty(signatureDate);
    Assert.NotEmpty(signerInfo);
    
    // User can download signature details
    var downloadBtn = await adminPage.QuerySelectorAsync("[data-testid='download-signature-report']");
    Assert.NotNull(downloadBtn);
}
```

**Focus:** Admin can verify invoice signatures  
**Standard Reference:** ERechnungsverordnung Anforderung  
**Acceptance:** Verification tool in admin, reports downloadable

---

### Test Group 3: Validation & Archiving (3 Tests)

#### Test 3.1: Invoice XML Validates Against Standard Schema
```csharp
[Fact]
public async Task InvoiceXML_ValidatesAgainstZUGFERDSchema()
{
    // Arrange
    var invoices = await _invoiceRepository.GetAllAsync();
    var schemaPath = _schemaProvider.GetZUGFeRDSchemaPath(); // Version 3.0
    
    // Act & Assert
    foreach (var invoice in invoices)
    {
        var xmlContent = await _invoiceService.GenerateZUGFeRDAsync(invoice.Order);
        
        // Validate XML schema
        var xdoc = XDocument.Load(new StringReader(xmlContent));
        var schemaSet = new XmlSchemaSet();
        schemaSet.Add("urn:un:unece:uncefact:documents:100:rsm", schemaPath);
        
        var errors = new List<string>();
        xdoc.Validate(schemaSet, (o, e) =>
        {
            errors.Add(e.Message);
        });
        
        Assert.Empty(errors, $"Schema validation failed for {invoice.InvoiceNumber}");
    }
}
```

**Focus:** All invoices validate against official ZUGFeRD 3.0 schema  
**Standard Reference:** ZUGFeRD 3.0 Schema  
**Acceptance:** 0 validation errors, schema version 3.0 confirmed

---

#### Test 3.2: Invoices Archived for 10 Years With Metadata
```csharp
[Fact]
public async Task InvoiceArchival_Stores10Years_WithMetadata_Immutable()
{
    // Arrange
    var oldInvoice = new Invoice
    {
        InvoiceNumber = "INV-2016-001",
        CreatedAt = new DateTime(2016, 1, 15),
        TenantId = Guid.NewGuid()
    };
    
    // Act - Archive invoice
    await _archiveService.ArchiveAsync(oldInvoice);
    
    // Assert - Archived with metadata
    var archived = await _archiveRepository.GetAsync(oldInvoice.Id);
    
    Assert.NotNull(archived);
    Assert.Equal(oldInvoice.InvoiceNumber, archived.InvoiceNumber);
    Assert.Equal(oldInvoice.CreatedAt, archived.CreatedAt);
    Assert.True(archived.IsArchived);
    Assert.NotNull(archived.ArchivedAt);
    
    // Tenant isolation maintained
    Assert.Equal(oldInvoice.TenantId, archived.TenantId);
    
    // Cannot modify archived invoices
    archived.InvoiceNumber = "HACKED";
    var ex = await Assert.ThrowsAsync<InvalidOperationException>(
        () => _archiveRepository.UpdateAsync(archived)
    );
    Assert.Contains("immutable", ex.Message);
}
```

**Focus:** Immutable archive for 10 years, cannot be modified  
**Standard Reference:** GoBD (Grunds√§tze der Ordnungsm√§√üigkeit)  
**Acceptance:** Encryption at rest, tenant isolated, immutable writes

---

#### Test 3.3: Invoice Export for Tax Audit
```csharp
[Fact]
public async Task InvoiceExport_AvailableForTaxAudit_PeriodicBatch()
{
    // Arrange
    var startDate = new DateTime(2024, 1, 1);
    var endDate = new DateTime(2024, 12, 31);
    
    // Act - Admin generates tax export
    var adminPage = await _browser.LoginAsAdminAsync();
    await adminPage.GoToAsync("https://localhost:5174/reports/invoices");
    
    await adminPage.FillAsync("[name='start_date']", "01/01/2024");
    await adminPage.FillAsync("[name='end_date']", "12/31/2024");
    await adminPage.ClickAsync("button[data-testid='generate-export']");
    
    // Assert - Export available
    var downloadLink = await adminPage.WaitForSelectorAsync("[data-testid='download-export']");
    Assert.NotNull(downloadLink);
    
    // Download contains all invoices
    var exportFile = await adminPage.EvaluateAsync<object>("() => document.lastDownloadPath");
    Assert.NotNull(exportFile);
    
    // Format: ZUGFeRD XML + PDF + metadata
    using (var zip = ZipFile.OpenRead(exportFile.ToString()))
    {
        var entries = zip.Entries.Select(e => e.Name).ToList();
        
        Assert.NotEmpty(entries.Where(e => e.EndsWith(".xml")));  // ZUGFeRD files
        Assert.NotEmpty(entries.Where(e => e.EndsWith(".pdf")));  // PDF copies
        Assert.Contains("invoice-metadata.csv", entries); // Metadata
    }
}
```

**Focus:** Batch export for tax authorities (Finanzbeh√∂rde)  
**Standard Reference:** GoBD Audit Trail  
**Acceptance:** All invoices exportable, formats standardized, timestamps accurate

---

### Test Group 4: ERP Integration (2 Tests)

#### Test 4.1: Invoice Import From Standard ERP Formats
```csharp
[Fact]
public async Task InvoiceImport_AcceptsZUGFERD_UBL_FromExternalSystems()
{
    // Arrange
    var zugferdFile = "samples/zugferd_from_sap.xml";
    var ublFile = "samples/ubl_from_netsuite.xml";
    
    // Act - Import ZUGFeRD
    var zugferdImport = await _invoiceImportService.ImportAsync(
        await File.ReadAllBytesAsync(zugferdFile),
        ImportFormat.ZUGFeRD3
    );
    
    // Assert - Successfully parsed
    Assert.NotNull(zugferdImport);
    Assert.NotEmpty(zugferdImport.InvoiceNumber);
    Assert.NotEmpty(zugferdImport.LineItems);
    Assert.True(zugferdImport.TotalAmount > 0);
    
    // Save to database
    await _invoiceRepository.AddAsync(zugferdImport);
    
    // Act - Import UBL
    var ublImport = await _invoiceImportService.ImportAsync(
        await File.ReadAllBytesAsync(ublFile),
        ImportFormat.UBL2_3
    );
    
    Assert.NotNull(ublImport);
    Assert.NotEmpty(ublImport.InvoiceNumber);
    
    // Both formats handled identically
    var savedZugferd = await _invoiceRepository.GetByNumberAsync(zugferdImport.InvoiceNumber);
    var savedUbl = await _invoiceRepository.GetByNumberAsync(ublImport.InvoiceNumber);
    
    Assert.NotNull(savedZugferd);
    Assert.NotNull(savedUbl);
}
```

**Focus:** Accept ZUGFeRD and UBL from SAP, NetSuite, Xero, etc.  
**Standard Reference:** ERechnungsverordnung Integration Point  
**Acceptance:** Parses both formats, saves to database, duplicate detection

---

#### Test 4.2: Invoice API for System-to-System Communication
```csharp
[Fact]
public async Task InvoiceAPI_SupportsWebhookForAutomaticTransmission()
{
    // Arrange
    var order = await CreateB2BOrderAsync();
    var webhookUrl = "https://erp.partner.com/api/invoices";
    
    var subscription = new WebhookSubscription
    {
        TenantId = order.TenantId,
        Event = "invoice.created",
        Url = webhookUrl,
        AuthToken = "secret-token"
    };
    
    await _webhookRepository.AddAsync(subscription);
    
    // Act - Invoice generated
    var invoice = await _invoiceService.GenerateAsync(order);
    
    // Assert - Webhook triggered
    var webhookCall = _httpClientMock.Requests
        .FirstOrDefault(r => r.RequestUri.ToString() == webhookUrl);
    
    Assert.NotNull(webhookCall);
    
    // Payload contains ZUGFeRD XML
    var content = await webhookCall.Content.ReadAsStringAsync();
    Assert.Contains("<rsm:CrossIndustryInvoice", content);
    
    // Authorization header present
    var authHeader = webhookCall.Headers.Authorization;
    Assert.NotNull(authHeader);
    Assert.Equal("Bearer secret-token", authHeader.ToString());
}
```

**Focus:** Webhook API for automatic ERP transmission  
**Standard Reference:** REST API + Webhook Pattern  
**Acceptance:** Webhooks trigger on invoice.created, payload includes XML, signed requests

---

## Test Summary Table

| Group | Test | Focus | Standard | Effort |
|-------|------|-------|----------|--------|
| 1.1 | ZUGFeRD XML Gen | Valid XML structure, VAT calc | ZUGFeRD 3.0 | 4h |
| 1.2 | Hybrid PDF | Embedded XML in PDF | PDF/A + ZUGFeRD | 4h |
| 1.3 | UBL Alternative | UBL 2.3 format support | UBL 2.3 | 3h |
| 2.1 | Digital Signature | XAdES-BES signature | XAdES/TS | 3h |
| 2.2 | Signature Verify | Admin verification tool | XAdES | 2h |
| 3.1 | Schema Validation | Validates against ZUGFeRD | ZUGFeRD 3.0 Schema | 2h |
| 3.2 | Archival 10yr | Immutable archive | GoBD | 3h |
| 3.3 | Tax Export | Batch export + metadata | GoBD Audit | 3h |
| 4.1 | ERP Import | ZUGFeRD + UBL import | ERechnungsVO | 4h |
| 4.2 | Webhook API | System-to-system transmission | REST API | 3h |
| **Total** | **10 Tests** | **Full E-Rechnung Compliance** | **ZUGFeRD 3.0 + UBL 2.3** | **32-35h** |

---

## Implementation Notes

### Technology Stack
- **XML Libraries:** System.Xml.Linq, XmlSchema validation
- **PDF:** PdfSharp with embedded file support
- **Cryptography:** BouncyCastle (XAdES-BES signing)
- **Testing:** Playwright for webhook verification

### Timeline
- **Weeks 1-2:** ZUGFeRD XML generation
- **Weeks 2-3:** Hybrid PDF creation
- **Weeks 3-4:** Digital signature (optional)
- **Weeks 4-5:** Validation & archival
- **Weeks 5-6:** ERP integration testing
- **Weeks 6-7:** Documentation & support

### Success Criteria
- ‚úÖ All 10 tests passing
- ‚úÖ ZUGFeRD schema validation (0 errors)
- ‚úÖ UBL support verified (at least SAP, NetSuite)
- ‚úÖ Webhook transmission tested with real ERP
- ‚úÖ Archival immutability proven

### Responsible Person
- **Backend Dev:** Invoice generation, archival
- **Integration Eng:** ERP webhooks, import
- **Security Eng:** Digital signature setup

---

## Regulatory References

**ERechnungsverordnung (E-Invoicing Directive):**
- Art. 1: Scope (B2B, B2C, B2G invoices)
- Art. 4: Structured data format (ZUGFeRD/UBL required)
- Art. 5: Digital signatures (optional, recommended)
- Art. 6: Archiving (10 years minimum)

**Standards Referenced:**
- **ZUGFeRD 3.0:** German/EU e-invoicing standard
- **UBL 2.3:** EU-wide e-invoicing standard
- **XAdES:** EU Digital Signatures Regulation
- **GoBD:** German bookkeeping requirements

**German Penalties:**
- ‚Ç¨5,000-50,000 per non-compliance
- Rejection by tax authorities
- Enterprise customer contracts blocked

---

**Effort:** 35-40 hours (1.5 FTE, 1.5 weeks parallel to other P0 work)  
**Dependencies:** P0.1 (audit logging), P0.2 (encryption)  
**Status:** Ready for implementation
