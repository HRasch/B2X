# ðŸ“‹ P0.6: E-Commerce Legal Compliance - Testing Examples

**Status:** Ready to Execute | **Last Updated:** 28. Dezember 2025

---

## B2C Specific Tests (14-Day Withdrawal Right, Price Transparency)

### Test 1: Verify 14-Day Withdrawal Period

```csharp
[Fact]
public async Task ReturnRequest_WithinWithdrawalPeriod_IsAccepted()
{
    // Arrange
    var order = new Order 
    { 
        DeliveryDate = DateTime.Now.AddDays(-5)  // Delivered 5 days ago
    };
    
    var returnRequest = new ReturnRequest
    {
        OrderId = order.Id,
        RequestDate = DateTime.Now,
        DeliveryDate = order.DeliveryDate
    };
    
    // Act
    var result = await _withdrawalService.CreateReturnRequestAsync(returnRequest);
    
    // Assert
    Assert.True(returnRequest.IsWithinWithdrawalPeriod);
    Assert.True(result.Success);
    Assert.Equal(9, returnRequest.WithdrawalDaysRemaining);  // 14 - 5 = 9 days left
}

[Fact]
public async Task ReturnRequest_AfterWithdrawalPeriod_IsRejected()
{
    // Arrange
    var order = new Order 
    { 
        DeliveryDate = DateTime.Now.AddDays(-15)  // Delivered 15 days ago
    };
    
    var returnRequest = new ReturnRequest
    {
        OrderId = order.Id,
        RequestDate = DateTime.Now,
        DeliveryDate = order.DeliveryDate
    };
    
    // Act & Assert
    await Assert.ThrowsAsync<InvalidOperationException>(
        () => _withdrawalService.CreateReturnRequestAsync(returnRequest)
    );
}
```

### Test 2: Price Transparency (Final Price + Shipping Before Checkout)

```csharp
[Theory]
[InlineData("DE", 100, "Standard", true)]
[InlineData("AT", 100, "Standard", true)]
[InlineData("FR", 100, "Express", true)]
public async Task PriceCalculation_IncludesVatAndShippingBeforeCheckout(
    string country,
    decimal productPrice,
    string shippingMethod,
    bool isB2c)
{
    // Arrange
    var priceBreakdown = _priceService.CalculateFinalPrice(
        productPrice,
        country,
        shippingMethod,
        isB2bWithVatId: !isB2c
    );
    
    // Act & Assert
    Assert.NotNull(priceBreakdown.VatRate);
    Assert.NotEqual(0, priceBreakdown.VatAmount);  // VAT calculated
    Assert.NotEqual(0, priceBreakdown.ShippingCost);  // Shipping included
    Assert.True(priceBreakdown.ShippingCostVisible);  // Visible before checkout
    Assert.Equal(
        priceBreakdown.ProductPrice + priceBreakdown.VatAmount + priceBreakdown.ShippingCost,
        priceBreakdown.FinalPrice
    );
}

[Fact]
public async Task PriceCalculation_ShowsOriginalPriceWhenDiscounted()
{
    // Arrange
    var originalPrice = 100m;
    var discountedPrice = 80m;  // 20% discount
    
    // Act
    var priceBreakdown = _priceService.CalculateFinalPrice(
        discountedPrice,
        "DE",
        "Standard",
        isB2bWithVatId: false
    );
    
    // Assert
    Assert.NotNull(priceBreakdown.OriginalPrice);
    Assert.Equal(originalPrice, priceBreakdown.OriginalPrice);
    Assert.NotEqual(originalPrice, priceBreakdown.ProductPrice);
}
```

### Test 3: Terms & Conditions Acceptance with Audit Log

```csharp
[Fact]
public async Task Checkout_RequiresTermsAcceptance_BeforeOrderCreation()
{
    // Arrange
    var checkoutRequest = new CheckoutRequest
    {
        Items = new[] { new CartItem { Sku = "TEST-001", Qty = 1 } },
        TermsAndConditionsAccepted = false  // Not accepted
    };
    
    // Act & Assert
    var result = await _checkoutService.CreateOrderAsync(checkoutRequest);
    
    Assert.False(result.Success);
    Assert.Contains("Terms and Conditions", result.Errors);
}

[Fact]
public async Task Checkout_AcceptanceAudited_WhenTermsAccepted()
{
    // Arrange
    var checkoutRequest = new CheckoutRequest
    {
        Items = new[] { new CartItem { Sku = "TEST-001", Qty = 1 } },
        TermsAndConditionsAccepted = true,
        AcceptanceTimestamp = DateTime.UtcNow
    };
    
    // Act
    var result = await _checkoutService.CreateOrderAsync(checkoutRequest);
    
    // Assert
    Assert.True(result.Success);
    
    var auditLog = await _auditService.GetAsync(x =>
        x.EntityType == "Order" &&
        x.Action == "CREATE" &&
        x.EntityId == result.OrderId
    );
    
    Assert.NotNull(auditLog);
    Assert.Contains("TermsAccepted", auditLog.NewValues);
}
```

### Test 4: Return Label Generation and Tracking

```csharp
[Fact]
public async Task ReturnLabel_GeneratedAutomatically_WhenReturnRequested()
{
    // Arrange
    var order = new Order { DeliveryDate = DateTime.Now.AddDays(-5) };
    var returnRequest = new ReturnRequest { OrderId = order.Id };
    
    // Act
    var label = await _withdrawalService.GenerateReturnLabelAsync(
        returnRequest,
        "DPD"  // Carrier
    );
    
    // Assert
    Assert.NotNull(label);
    Assert.NotEmpty(label.Number);
    Assert.Equal("DPD", label.Carrier);
    Assert.True(label.IsValid);
}

[Fact]
public async Task ReturnLabel_AuditsGeneration_WithTimestampAndCarrier()
{
    // Arrange
    var order = new Order { DeliveryDate = DateTime.Now.AddDays(-5) };
    var returnRequest = new ReturnRequest { OrderId = order.Id };
    
    // Act
    var label = await _withdrawalService.GenerateReturnLabelAsync(returnRequest, "DPD");
    
    // Assert
    var auditLog = await _auditService.GetAsync(x =>
        x.Action == "ReturnLabelGenerated" &&
        x.EntityId == order.Id.ToString()
    );
    
    Assert.NotNull(auditLog);
    Assert.Contains("DPD", auditLog.NewValues);
}
```

---

## B2B Specific Tests (VAT-ID, Reverse Charge, Payment Terms)

### Test 5: VAT-ID Validation (VIES API)

```csharp
[Fact]
public async Task VatIdValidation_ValidatesWithViesApi()
{
    // Arrange
    var vatId = "DE123456789";
    
    // Act
    var result = await _vatService.ValidateVatIdAsync("DE", "123456789");
    
    // Assert
    Assert.True(result.IsValid);
    Assert.Equal("DE", result.CountryCode);
    Assert.Equal("123456789", result.VatNumber);
    Assert.NotEmpty(result.CompanyName);
    Assert.NotEmpty(result.CompanyAddress);
}

[Fact]
public async Task VatIdValidation_RejectsInvalidId()
{
    // Arrange
    var invalidVatId = "DE999999999";  // Invalid
    
    // Act & Assert
    await Assert.ThrowsAsync<InvalidOperationException>(
        () => _vatService.ValidateVatIdAsync("DE", "999999999")
    );
}

[Fact]
public async Task VatIdValidation_CachesForOneYear()
{
    // Arrange
    var vatId = "AT123456789";
    
    // Act
    var result = await _vatService.ValidateVatIdAsync("AT", "123456789");
    
    // Assert
    Assert.NotNull(result.ExpiresAt);
    Assert.True(result.ExpiresAt > DateTime.UtcNow.AddDays(360));
    Assert.True(result.ExpiresAt <= DateTime.UtcNow.AddDays(365));
}
```

### Test 6: Reverse Charge Logic (B2B with Valid VAT-ID)

```csharp
[Fact]
public void ReverseCharge_AppliedWhen_ValidVatIdAndDifferentCountry()
{
    // Arrange
    var sellerCountry = "DE";
    var buyerCountry = "AT";
    var vatValidation = new VatValidationResult { IsValid = true };
    
    // Act
    var shouldApplyReverseCharge = _vatService.ShouldApplyReverseCharge(
        vatValidation,
        buyerCountry,
        sellerCountry
    );
    
    // Assert
    Assert.True(shouldApplyReverseCharge);
}

[Fact]
public void ReverseCharge_NotApplied_WhenVatIdInvalid()
{
    // Arrange
    var sellerCountry = "DE";
    var buyerCountry = "AT";
    var vatValidation = new VatValidationResult { IsValid = false };
    
    // Act
    var shouldApplyReverseCharge = _vatService.ShouldApplyReverseCharge(
        vatValidation,
        buyerCountry,
        sellerCountry
    );
    
    // Assert
    Assert.False(shouldApplyReverseCharge);
}

[Fact]
public async Task B2bOrder_NoVat_WhenReverseChargeApplies()
{
    // Arrange
    var order = new B2bOrder
    {
        ProductPrice = 100m,
        BuyerCountry = "AT",
        SellerCountry = "DE",
        VatIdValidated = "AT123456789"
    };
    
    // Act
    var priceBreakdown = _priceService.CalculateFinalPrice(
        order.ProductPrice,
        order.BuyerCountry,
        "Standard",
        isB2bWithVatId: true  // Valid VAT-ID
    );
    
    // Assert
    Assert.Equal(0, priceBreakdown.VatAmount);  // No VAT!
    Assert.Equal(order.ProductPrice, priceBreakdown.FinalPrice);
}
```

### Test 7: Payment Terms Configuration (B2B)

```csharp
[Theory]
[InlineData(14)]  // Net 14
[InlineData(30)]  // Net 30
[InlineData(60)]  // Net 60
public async Task B2bOrder_PaymentTermsConfigurable(int netDays)
{
    // Arrange
    var order = new B2bOrder
    {
        CreatedAt = DateTime.Now,
        NetDays = netDays
    };
    
    // Act & Assert
    Assert.Equal(
        DateTime.Now.AddDays(netDays),
        order.DueDate,
        TimeSpan.FromSeconds(1)  // Allow 1 sec tolerance
    );
}

[Fact]
public async Task B2bOrder_MinimumOrderValueEnforced()
{
    // Arrange
    var order = new B2bOrder
    {
        Total = 500m,
        MinimumOrderValue = 1000m  // Minimum 1000â‚¬
    };
    
    var validationResult = await _b2bService.ValidateB2bOrderAsync(order);
    
    // Assert
    Assert.False(validationResult.IsValid);
    Assert.Contains("below minimum", validationResult.Errors[0]);
}
```

### Test 8: INCOTERMS Support (Shipping Terms)

```csharp
[Theory]
[InlineData("DDP")]  // Delivered Duty Paid (seller pays shipping/duties)
[InlineData("DDU")]  // Delivered Duty Unpaid (buyer pays duties)
[InlineData("CIF")]  // Cost, Insurance & Freight
[InlineData("FOB")]  // Free on Board
public async Task B2bOrder_SupportsIncoterms(string incoterm)
{
    // Arrange
    var order = new B2bOrder { Incoterm = incoterm };
    
    // Act
    var result = await _b2bService.ValidateB2bOrderAsync(order);
    
    // Assert
    Assert.True(result.IsValid);
}

[Theory]
[InlineData("DDP")]  // Seller pays
[InlineData("CIF")]  // Seller pays
public async Task B2bOrder_ShippingPaidBySeller_WhenDdpOrCif(string incoterm)
{
    // Arrange
    var order = new B2bOrder { Incoterm = incoterm };
    
    // Act & Assert
    Assert.False(order.BuyerPaysShipping);
}

[Theory]
[InlineData("DDU")]  // Buyer pays
[InlineData("FOB")]  // Buyer pays
public async Task B2bOrder_ShippingPaidByBuyer_WhenDduOrFob(string incoterm)
{
    // Arrange
    var order = new B2bOrder { Incoterm = incoterm };
    
    // Act & Assert
    Assert.True(order.BuyerPaysShipping);
}
```

---

## Invoice Management Tests (10-Year Archival)

### Test 9: Invoice Generation and Archival

```csharp
[Fact]
public async Task Invoice_CreatedAndArchived_WithEncryption()
{
    // Arrange
    var order = new Order
    {
        Id = Guid.NewGuid(),
        Total = 500m,
        Items = new[] { new OrderItem { Sku = "TEST-001", Qty = 2, Price = 250m } }
    };
    
    // Act
    var invoice = await _invoiceService.CreateInvoiceAsync(order, null);
    
    // Assert
    Assert.NotNull(invoice.InvoiceNumber);
    Assert.NotEqual(Guid.Empty, invoice.Id);
    
    // Verify stored encrypted
    var stored = await _invoiceStorage.GetAsync(invoice.InvoiceNumber);
    Assert.True(stored.IsEncrypted);
}

[Fact]
public async Task Invoice_UniqueNumberPerShop()
{
    // Arrange
    var order1 = new Order { TenantId = Guid.NewGuid() };
    var order2 = new Order { TenantId = order1.TenantId };
    
    // Act
    var invoice1 = await _invoiceService.CreateInvoiceAsync(order1, null);
    var invoice2 = await _invoiceService.CreateInvoiceAsync(order2, null);
    
    // Assert
    Assert.NotEqual(invoice1.InvoiceNumber, invoice2.InvoiceNumber);
}

[Fact]
public async Task Invoice_ArchivedAfter10Years()
{
    // Arrange
    var cutoffDate = DateTime.UtcNow.AddYears(-10);
    var oldInvoice = new Invoice { CreatedAt = cutoffDate.AddDays(-1) };
    
    // Act
    await _invoiceService.ArchiveOldInvoicesAsync();
    
    // Assert
    var archived = await _invoiceStorage.GetArchivedAsync(oldInvoice.InvoiceNumber);
    Assert.NotNull(archived);
    Assert.True(archived.IsArchived);
}
```

### Test 10: Invoice Includes All Legally Required Info

```csharp
[Fact]
public async Task Invoice_ContainsAllRequiredFields()
{
    // Arrange
    var order = new Order
    {
        CustomerNameEncrypted = "John Doe",
        CustomerEmailEncrypted = "john@example.com",
        CustomerAddressEncrypted = "Main St. 123",
        SubTotal = 400m,
        VatAmount = 76m,
        ShippingCost = 24m,
        Total = 500m
    };
    
    // Act
    var invoice = await _invoiceService.CreateInvoiceAsync(order, null);
    
    // Assert (legally required)
    Assert.NotNull(invoice.InvoiceNumber);
    Assert.NotNull(invoice.CreatedAt);
    Assert.NotEmpty(invoice.LineItems);
    Assert.NotEqual(0, invoice.SubTotal);
    Assert.NotEqual(0, invoice.VatAmount);
    Assert.NotEqual(0, invoice.Total);
}

[Fact]
public async Task Invoice_SentToCustomer_Immediately()
{
    // Arrange
    var order = new Order { CustomerEmailEncrypted = "test@example.com" };
    
    // Act
    var invoice = await _invoiceService.CreateInvoiceAsync(order, null);
    
    // Assert
    _emailServiceMock.Verify(
        x => x.SendInvoiceAsync("test@example.com", It.IsAny<Invoice>()),
        Times.Once
    );
}
```

---

## Integration Tests (B2B + B2C Mixed)

### Test 11: B2C Customer Cannot Use B2B Terms

```csharp
[Fact]
public async Task B2cCheckout_CannotSelectB2bPaymentTerms()
{
    // Arrange
    var checkoutRequest = new CheckoutRequest
    {
        OrderType = OrderType.B2C,
        PaymentTerms = PaymentTermsOption.Net60  // B2B only
    };
    
    // Act & Assert
    var result = await _checkoutService.ValidateCheckoutAsync(checkoutRequest);
    Assert.False(result.IsValid);
    Assert.Contains("B2C", result.Errors[0]);
}
```

### Test 12: B2B Order Cannot Be Completed Without Valid VAT-ID

```csharp
[Fact]
public async Task B2bCheckout_RejectedWithoutValidVatId()
{
    // Arrange
    var checkoutRequest = new CheckoutRequest
    {
        OrderType = OrderType.B2B,
        VatId = ""  // No VAT-ID
    };
    
    // Act & Assert
    var result = await _checkoutService.CreateOrderAsync(checkoutRequest);
    Assert.False(result.Success);
    Assert.Contains("VAT-ID", result.Errors[0]);
}

[Fact]
public async Task B2bCheckout_SucceedsWithValidVatId()
{
    // Arrange
    var checkoutRequest = new CheckoutRequest
    {
        OrderType = OrderType.B2B,
        VatId = "DE123456789"
    };
    
    // Act
    var result = await _checkoutService.CreateOrderAsync(checkoutRequest);
    
    // Assert
    Assert.True(result.Success);
    Assert.NotEqual(Guid.Empty, result.OrderId);
}
```

---

## Performance Tests

### Test 13: Invoice Generation Performance

```csharp
[Fact]
public async Task InvoiceGeneration_CompletesUnder2Seconds()
{
    // Arrange
    var order = new Order { Items = new OrderItem[100] };  // Large order
    var stopwatch = Stopwatch.StartNew();
    
    // Act
    var invoice = await _invoiceService.CreateInvoiceAsync(order, null);
    stopwatch.Stop();
    
    // Assert
    Assert.True(stopwatch.ElapsedMilliseconds < 2000, 
        $"Invoice generation took {stopwatch.ElapsedMilliseconds}ms, expected < 2000ms");
}
```

### Test 14: VAT-ID Validation Performance

```csharp
[Fact]
public async Task VatIdValidation_CompletesUnder500Ms()
{
    // Arrange
    var stopwatch = Stopwatch.StartNew();
    
    // Act
    var result = await _vatService.ValidateVatIdAsync("DE", "123456789");
    stopwatch.Stop();
    
    // Assert
    Assert.True(stopwatch.ElapsedMilliseconds < 500,
        $"VAT validation took {stopwatch.ElapsedMilliseconds}ms, expected < 500ms");
}
```

---

## Accessibility & Privacy Tests

### Test 15: Impressum and Privacy Required on Checkout

```csharp
[Fact]
public async Task Checkout_DisplaysImpressionAndPrivacy_BeforeConfirmation()
{
    // Arrange
    var checkoutPage = new CheckoutPage();
    
    // Act
    var impressumLink = checkoutPage.GetFooterLink("Impressum");
    var privacyLink = checkoutPage.GetFooterLink("Datenschutz");
    
    // Assert
    Assert.NotNull(impressumLink);
    Assert.NotNull(privacyLink);
    Assert.False(impressumLink.IsDisabled);
    Assert.False(privacyLink.IsDisabled);
}
```

---

**All 15 tests together cover:**
âœ… B2C legal requirements (14-day returns, price transparency, terms)
âœ… B2B legal requirements (VAT-ID, reverse charge, payment terms)
âœ… Invoice management (generation, archival, encryption)
âœ… Performance targets (< 2s invoice, < 500ms VAT validation)
âœ… Accessibility (links to legal docs always visible)

**Total Test Count:** 25+ test cases covering P0.6 requirements

