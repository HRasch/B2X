#!/bin/bash# B2X MCP Pre-Commit Hook# Validates token limits and cache status before commit# Install: cp scripts/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commitset -eREPO_ROOT="$(git rev-parse --show-toplevel)"cd "$REPO_ROOT"# Color codesRED='\033[0;31m'GREEN='\033[0;32m'YELLOW='\033[1;33m'NC='\033[0m' # No Colorecho "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"echo "🔍 B2X MCP Pre-Commit Validation"echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"echo ""# Step 1: Check rate limitsecho "📊 Step 1: Checking MCP rate limits..."RATE_CHECK=$(node scripts/mcp-rate-limiter.js summary 2>&1)if echo "$RATE_CHECK" | grep -q "exceeded"; then    echo -e "${RED}✗ FAILED: Rate limits exceeded${NC}"    echo "$RATE_CHECK"    exit 1fi# Check if any server is >80% of daily limitif echo "$RATE_CHECK" | grep -E "9[0-9]\.[0-9]|100\.0"; then    echo -e "${YELLOW}⚠️ WARNING: Server approaching rate limit${NC}"    echo "$RATE_CHECK"    echo ""    read -p "Continue commit? (y/N) " -n 1 -r    echo    if [[ ! $REPLY =~ ^[Yy]$ ]]; then        exit 1    fifiecho -e "${GREEN}✓ PASSED: All rate limits OK${NC}"echo ""# Step 2: Check cache statusecho "🗄️ Step 2: Checking cache status..."CACHE_STATS=$(node scripts/mcp-cache-manager.js stats 2>&1 | head -20)if [ -n "$CACHE_STATS" ]; then    echo "$CACHE_STATS"    echo -e "${GREEN}✓ PASSED: Cache operational${NC}"else    echo -e "${YELLOW}⚠️ WARNING: Cache not yet initialized${NC}"fiecho ""# Step 3: Validate changed files for MCP triggersecho "🔎 Step 3: Scanning changed files for MCP opportunities..."CHANGED_FILES=$(git diff --cached --name-only | grep -E '\.(ts|vue|js|cs)$' | head -10)if [ -n "$CHANGED_FILES" ]; then    echo "Changed files to validate:"    echo "$CHANGED_FILES" | sed 's/^/  /'    echo ""        # Optionally run MCP checks on critical files    CRITICAL_FILES=$(git diff --cached --name-only | grep -E '(\.cs$|security|auth|payment)')    if [ -n "$CRITICAL_FILES" ]; then        echo -e "${YELLOW}⚠️ SECURITY FILES DETECTED${NC}"        echo "Security-related files changed. Ensure security-mcp validation:"        echo "$CRITICAL_FILES" | sed 's/^/  - /'        echo ""    fielse    echo "No TypeScript/Vue/C# files changed"    echo ""fi# Step 4: Log commit activityecho "📝 Step 4: Logging commit activity..."COMMIT_MESSAGE="${1:-Pre-commit validation}"node scripts/mcp-audit-trail.js log-commit \    --message "$COMMIT_MESSAGE" \    --files "$CHANGED_FILES" 2>/dev/null || trueecho -e "${GREEN}✓ PASSED: Activity logged${NC}"echo ""# Final statusecho "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"echo -e "${GREEN}✅ Pre-commit validation PASSED${NC}"echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"echo ""exit 0