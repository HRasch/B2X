#!/bin/bash
# B2Connect MCP Pre-Commit Hook
# Validates token limits and cache status before commit
# Install: cp scripts/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

set -e

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "🔍 B2Connect MCP Pre-Commit Validation"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# Step 1: Check rate limits
echo "📊 Step 1: Checking MCP rate limits..."
RATE_CHECK=$(node scripts/mcp-rate-limiter.js summary 2>&1)

if echo "$RATE_CHECK" | grep -q "exceeded"; then
    echo -e "${RED}✗ FAILED: Rate limits exceeded${NC}"
    echo "$RATE_CHECK"
    exit 1
fi

# Check if any server is >80% of daily limit
if echo "$RATE_CHECK" | grep -E "9[0-9]\.[0-9]|100\.0"; then
    echo -e "${YELLOW}⚠️ WARNING: Server approaching rate limit${NC}"
    echo "$RATE_CHECK"
    echo ""
    read -p "Continue commit? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

echo -e "${GREEN}✓ PASSED: All rate limits OK${NC}"
echo ""

# Step 2: Check cache status
echo "🗄️ Step 2: Checking cache status..."
CACHE_STATS=$(node scripts/mcp-cache-manager.js stats 2>&1 | head -20)

if [ -n "$CACHE_STATS" ]; then
    echo "$CACHE_STATS"
    echo -e "${GREEN}✓ PASSED: Cache operational${NC}"
else
    echo -e "${YELLOW}⚠️ WARNING: Cache not yet initialized${NC}"
fi
echo ""

# Step 3: Validate changed files for MCP triggers
echo "🔎 Step 3: Scanning changed files for MCP opportunities..."
CHANGED_FILES=$(git diff --cached --name-only | grep -E '\.(ts|vue|js|cs)$' | head -10)

if [ -n "$CHANGED_FILES" ]; then
    echo "Changed files to validate:"
    echo "$CHANGED_FILES" | sed 's/^/  /'
    echo ""
    
    # Optionally run MCP checks on critical files
    CRITICAL_FILES=$(git diff --cached --name-only | grep -E '(\.cs$|security|auth|payment)')
    if [ -n "$CRITICAL_FILES" ]; then
        echo -e "${YELLOW}⚠️ SECURITY FILES DETECTED${NC}"
        echo "Security-related files changed. Ensure security-mcp validation:"
        echo "$CRITICAL_FILES" | sed 's/^/  - /'
        echo ""
    fi
else
    echo "No TypeScript/Vue/C# files changed"
    echo ""
fi

# Step 4: Log commit activity
echo "📝 Step 4: Logging commit activity..."
COMMIT_MESSAGE="${1:-Pre-commit validation}"
node scripts/mcp-audit-trail.js log-commit \
    --message "$COMMIT_MESSAGE" \
    --files "$CHANGED_FILES" 2>/dev/null || true
echo -e "${GREEN}✓ PASSED: Activity logged${NC}"
echo ""

# Final status
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo -e "${GREEN}✅ Pre-commit validation PASSED${NC}"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

exit 0
