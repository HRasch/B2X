# ðŸ¦¾ P0.8: Barrierefreiheit (BITV 2.0) - Test Specifications

**Regulatory Driver:** BITV 2.0 (Barrierefreie Informationstechnik-Verordnung)  
**Deadline:** 28. Juni 2025 (ACTIVE!)  
**Penalties:** â‚¬5.000-100.000 BuÃŸgeld + Reputationsschaden  
**Effort:** 45 hours (1.5 weeks, 1.5 FTE)

---

## Overview

BITV 2.0 verpflichtet alle **Ã¶ffentlich zugÃ¤nglichen digitalen Dienste** zur Barrierefreiheit:
- âœ… Webseiten & Apps barrierefreie Bedienung
- âœ… Videos mit Untertiteln
- âœ… Bilder mit Alt-Texten
- âœ… Tastaturnavigation (kein Mouse-Only)
- âœ… Bildschirmleser-KompatibilitÃ¤t
- âœ… Farbkontrast (WCAG AA minimum)

**B2Connect Impact:**
- Store Frontend (5173) â†’ Muss BITV konform sein
- Admin Frontend (5174) â†’ Muss BITV konform sein
- REST APIs â†’ MÃ¼ssen barrierefreie Fehlerausgaben haben

---

## 12 Test Cases fÃ¼r BITV 2.0 Compliance

### Test Group 1: Keyboard Navigation (3 Tests)

#### Test 1.1: StoreFront - Complete Navigation via Keyboard
```csharp
[Fact]
public async Task StoreFront_AllFunctionalityAccessible_ViaKeyboardOnly()
{
    // Arrange
    var page = await _browser.GoToAsync("https://localhost:5173");
    
    // Act - Simulate keyboard-only user
    var canNavigateHeader = await page.Keyboard.PressAsync("Tab"); // Menu
    var canOpenMenu = await page.Keyboard.PressAsync("Enter");
    var canNavigateProducts = await page.Keyboard.PressAsync("Tab");
    var canSearch = await page.Keyboard.PressAsync("Tab");
    var canAddToCart = await page.Keyboard.PressAsync("Tab");
    var canCheckout = await page.Keyboard.PressAsync("Tab");
    
    // Assert - All major functions accessible without mouse
    Assert.True(canNavigateHeader && canOpenMenu && canNavigateProducts 
        && canSearch && canAddToCart && canCheckout);
    
    // Verify focus visible (not hidden)
    var focusRing = await page.Evaluate<bool>(
        "() => window.getComputedStyle(document.activeElement).outline !== 'none'"
    );
    Assert.True(focusRing);
}
```

**Focus:** TAB/SHIFT+TAB navigates all controls, focus indicator visible  
**WCAG Reference:** WCAG 2.1 2.1.1 Keyboard  
**Acceptance:** Tab order logical, focus ring visible, all buttons clickable with Enter

---

#### Test 1.2: AdminPanel - Keyboard Shortcuts for Power Users
```csharp
[Fact]
public async Task AdminPanel_ProvideAccessibleKeyboardShortcuts_ForCommonTasks()
{
    // Arrange
    var adminPage = await _browser.LoginAsAdminAsync();
    
    // Act & Assert
    var tests = new Dictionary<string, Func<Task<bool>>>
    {
        { "Search Products", async () => 
            (await _browser.Keyboard.PressAsync("Shift+F")).Success },
        
        { "Create New Product", async () => 
            (await _browser.Keyboard.PressAsync("Shift+N")).Success },
        
        { "Save Changes", async () => 
            (await _browser.Keyboard.PressAsync("Ctrl+S")).Success },
        
        { "Escape Modal", async () => 
            (await _browser.Keyboard.PressAsync("Escape")).Success },
        
        { "Help/Documentation", async () => 
            (await _browser.Keyboard.PressAsync("Shift+?")).Success }
    };
    
    foreach (var (shortcut, test) in tests)
    {
        Assert.True(await test(), $"Shortcut failed: {shortcut}");
    }
}
```

**Focus:** Common admin tasks have keyboard shortcuts (Shift+F, Shift+N, Ctrl+S)  
**WCAG Reference:** WCAG 2.1 2.1.3 Keyboard (No Exception)  
**Acceptance:** All shortcuts documented in help, discoverable via ? key

---

#### Test 1.3: No Keyboard Traps - User Can Escape All Modals
```csharp
[Fact]
public async Task ModalDialogs_CanBeClosedWithKeyboard_NoTraps()
{
    // Arrange
    var page = await _browser.GoToAsync("https://localhost:5173/checkout");
    await page.ClickAsync("[data-testid='apply-coupon-button']");
    var modal = await page.WaitForSelectorAsync("[role='dialog']");
    
    // Act - User tries to Tab away
    var initialFocus = await page.Evaluate<string>("document.activeElement.id");
    
    // Trap check: Press Tab many times
    for (int i = 0; i < 10; i++)
    {
        await page.Keyboard.PressAsync("Tab");
    }
    
    var finalFocus = await page.Evaluate<string>("document.activeElement.id");
    
    // Assert - User was NOT trapped in modal
    Assert.NotEqual(initialFocus, finalFocus); // Focus moved
    
    // User can Escape modal
    await page.Keyboard.PressAsync("Escape");
    var modalClosed = await page.QuerySelectorAsync("[role='dialog']");
    Assert.Null(modalClosed);
}
```

**Focus:** No keyboard traps, Escape key closes modals, focus returns to opener  
**WCAG Reference:** WCAG 2.1 2.1.2 No Keyboard Trap  
**Acceptance:** User can Tab through entire app, Escape works everywhere

---

### Test Group 2: Screen Reader Support (3 Tests)

#### Test 2.1: StoreFront Products Have Semantic HTML & ARIA Labels
```csharp
[Fact]
public async Task ProductListing_HasProperSemanticHTML_ForScreenReaders()
{
    // Arrange
    var page = await _browser.GoToAsync("https://localhost:5173/products");
    
    // Act - Check semantic structure
    var productList = await page.QuerySelectorAsync("[role='main']");
    var products = await page.QuerySelectorAllAsync("article[role='article']");
    
    // Assert - Proper semantic markup
    Assert.NotNull(productList); // Main landmark present
    Assert.NotEmpty(products);    // Products are articles
    
    foreach (var product in products)
    {
        // Each product has accessible name
        var name = await product.GetAttributeAsync("aria-label");
        var heading = await product.QuerySelectorAsync("h2");
        
        Assert.True(!string.IsNullOrEmpty(name) || heading != null,
            "Product must have accessible name via aria-label or heading");
    }
    
    // Each product has proper button roles
    var addToCartButtons = await page.QuerySelectorAllAsync("button[aria-label*='Add']");
    Assert.NotEmpty(addToCartButtons);
}
```

**Focus:** Products use `<article>` tags, buttons have `aria-label`, headings structure content  
**WCAG Reference:** WCAG 2.1 1.3.1 Info and Relationships  
**Acceptance:** NVDA/JAWS announces structure correctly, landmarks detectable

---

#### Test 2.2: AdminPanel Form Controls Properly Labeled
```csharp
[Fact]
public async Task AdminPanel_FormControls_ProperlyLabeled_ForScreenReaders()
{
    // Arrange
    var adminPage = await _browser.LoginAsAdminAsync();
    await adminPage.GoToAsync("https://localhost:5174/products/new");
    
    // Act & Assert
    var formControls = new[]
    {
        ("product-sku", "Product SKU"),
        ("product-name", "Product Name"),
        ("product-price", "Price"),
        ("product-description", "Description")
    };
    
    foreach (var (controlId, expectedLabel) in formControls)
    {
        var control = await adminPage.QuerySelectorAsync($"#{controlId}");
        var label = await adminPage.QuerySelectorAsync($"label[for='{controlId}']");
        var ariaLabel = await control.GetAttributeAsync("aria-label");
        
        // Either <label> or aria-label required
        Assert.True(label != null || ariaLabel == expectedLabel,
            $"Control {controlId} must have label or aria-label");
        
        // Required fields marked
        var required = await control.GetAttributeAsync("required");
        if (required != null)
        {
            var requiredMarker = await label?.TextContentAsync();
            Assert.Contains("*", requiredMarker ?? "");
        }
    }
}
```

**Focus:** Form inputs have `<label>` or `aria-label`, required fields marked with `*`  
**WCAG Reference:** WCAG 2.1 1.3.1 Info and Relationships  
**Acceptance:** NVDA announces label + required status, no orphaned inputs

---

#### Test 2.3: Error Messages Announced to Screen Readers
```csharp
[Fact]
public async Task FormValidation_ErrorsAnnounced_ToScreenReaders()
{
    // Arrange
    var page = await _browser.GoToAsync("https://localhost:5173/register");
    
    // Act - Submit invalid email
    await page.FillAsync("[name='email']", "invalid-email");
    await page.ClickAsync("button[type='submit']");
    
    // Assert - Error announced in live region
    var liveRegion = await page.WaitForSelectorAsync("[role='alert']");
    var errorText = await liveRegion.TextContentAsync();
    
    Assert.Contains("invalid", errorText.ToLower());
    
    // Associated with field
    var emailField = await page.QuerySelectorAsync("[name='email']");
    var ariaDescribedBy = await emailField.GetAttributeAsync("aria-describedby");
    var errorRegion = await page.QuerySelectorAsync($"#{ariaDescribedBy}");
    
    Assert.NotNull(errorRegion);
    Assert.Equal(liveRegion, errorRegion); // Same element
}
```

**Focus:** Form errors in `<div role="alert">`, linked to field via `aria-describedby`  
**WCAG Reference:** WCAG 2.1 3.3.1 Error Identification  
**Acceptance:** NVDA announces error immediately, linked to field

---

### Test Group 3: Visual Accessibility (2 Tests)

#### Test 3.1: Color Contrast Meets WCAG AA Minimum (4.5:1)
```csharp
[Fact]
public async Task UI_ColorContrast_MeetsWCAG_AAStandard()
{
    // Arrange
    var page = await _browser.GoToAsync("https://localhost:5173");
    
    // Act - Extract all text elements with color
    var elements = await page.EvaluateAsync<List<ColorData>>(
        @"() => {
            const results = [];
            document.querySelectorAll('p, a, button, h1, h2, h3, h4, h5, h6, span').forEach(el => {
                const color = window.getComputedStyle(el).color;
                const bgColor = window.getComputedStyle(el).backgroundColor;
                const text = el.textContent?.trim();
                if (text?.length > 0) {
                    results.push({ color, bgColor, text, fontSize: window.getComputedStyle(el).fontSize });
                }
            });
            return results;
        }"
    );
    
    // Assert - Calculate contrast ratio
    foreach (var el in elements)
    {
        var contrastRatio = ContrastRatioCalculator.Calculate(el.Color, el.BgColor);
        var minimumRequired = el.FontSize.Contains("14") ? 4.5 : 3.0; // 14px+ needs 4.5:1
        
        Assert.True(contrastRatio >= minimumRequired,
            $"Contrast {contrastRatio} too low for '{el.Text}'. Need {minimumRequired}:1");
    }
}
```

**Focus:** All text has contrast ratio >= 4.5:1 (AA standard)  
**WCAG Reference:** WCAG 2.1 1.4.3 Contrast (Minimum)  
**Acceptance:** Automated testing finds no violations, no hardcoded color issues

---

#### Test 3.2: Text Resizable to 200% Without Loss of Functionality
```csharp
[Fact]
public async Task UI_Text_Resizable_To200Percent_WithoutBreakage()
{
    // Arrange
    var page = await _browser.GoToAsync("https://localhost:5173");
    
    // Act - Zoom to 200%
    await page.EvaluateAsync("() => document.body.style.zoom = '200%'");
    
    // Assert - All content still visible
    var viewport = await page.ViewportSizeAsync();
    var bodyScroll = await page.EvaluateAsync<bool>(
        "() => document.body.scrollWidth > window.innerWidth"
    );
    
    // Some horizontal scroll OK, but no broken layout
    var brokenElements = await page.EvaluateAsync<List<string>>(
        @"() => {
            const broken = [];
            document.querySelectorAll('[class*=""hidden""], [style*=""overflow:hidden""]').forEach(el => {
                if (el.scrollWidth > el.clientWidth) {
                    broken.push(el.className || el.id);
                }
            });
            return broken;
        }"
    );
    
    Assert.Empty(brokenElements); // No hidden overflow at 200%
    
    // All buttons still clickable
    var buttons = await page.QuerySelectorAllAsync("button");
    foreach (var button in buttons)
    {
        var box = await button.BoundingBoxAsync();
        Assert.True(box.Width >= 30 && box.Height >= 30, "Button too small after zoom");
    }
}
```

**Focus:** Text zoom 200% doesn't break layout, all buttons clickable  
**WCAG Reference:** WCAG 2.1 1.4.4 Resize Text  
**Acceptance:** No content hidden, horizontal scrolling acceptable, buttons accessible

---

### Test Group 4: Video & Media Accessibility (2 Tests)

#### Test 4.1: All Videos Have Captions (Untertitel)
```csharp
[Fact]
public async Task Videos_HaveCaptions_InBothLanguages()
{
    // Arrange
    var page = await _browser.GoToAsync("https://localhost:5174/products/video-demo");
    
    // Act - Find all video elements
    var videos = await page.QuerySelectorAllAsync("video, iframe[src*='youtube'], iframe[src*='vimeo']");
    
    Assert.NotEmpty(videos);
    
    foreach (var video in videos)
    {
        var tagName = await video.EvaluateAsync<string>("el => el.tagName");
        
        if (tagName == "VIDEO")
        {
            // Native video: check for <track> with captions
            var tracks = await video.QuerySelectorAllAsync("track[kind='captions']");
            Assert.NotEmpty(tracks, "Native video must have caption tracks");
            
            // Multiple languages
            var languages = await video.EvaluateAsync<List<string>>(
                "el => Array.from(el.querySelectorAll('track[kind=\"captions\"]')).map(t => t.srclang)"
            );
            
            Assert.True(languages.Count >= 2 || languages.Contains("en"), // English minimum
                "Video must have at least 2 language captions");
        }
        else if (tagName == "IFRAME")
        {
            // YouTube/Vimeo: check if captions enabled
            var captionStatus = await video.GetAttributeAsync("allow");
            Assert.Contains("caption", captionStatus ?? "");
        }
    }
}
```

**Focus:** All videos have caption tracks, minimum 2 languages (DE, EN)  
**WCAG Reference:** WCAG 2.1 1.2.2 Captions (Prerecorded)  
**Acceptance:** VTT caption files present, DE + EN, tested in player

---

#### Test 4.2: Audio Description for Complex Videos
```csharp
[Fact]
public async Task ComplexVideos_HaveAudioDescription_Track()
{
    // Arrange
    var page = await _browser.GoToAsync("https://localhost:5174/demo/product-tutorial");
    var video = await page.QuerySelectorAsync("video");
    
    // Act - Check for audio description track
    var audioDescTrack = await video.QuerySelectorAsync("track[kind='descriptions']");
    
    // Assert
    Assert.NotNull(audioDescTrack, "Complex video must have audio description track");
    
    var srcUrl = await audioDescTrack.GetAttributeAsync("src");
    Assert.False(string.IsNullOrEmpty(srcUrl), "Audio description track must have src URL");
    
    // Verify file exists and is non-empty
    var audioFileSize = await _httpClient.HeadAsync(srcUrl);
    Assert.True(audioFileSize.Content.Headers.ContentLength > 1000,
        "Audio description file must be substantial (not placeholder)");
}
```

**Focus:** Complex tutorials have separate audio description track  
**WCAG Reference:** WCAG 2.1 1.2.5 Audio Description (Prerecorded)  
**Acceptance:** .vtt file with audio descriptions, tested in player

---

### Test Group 5: Content Accessibility (2 Tests)

#### Test 5.1: Page Titles and Headings Descriptive
```csharp
[Fact]
public async Task Pages_HaveDescriptiveTitles_AndHeadingStructure()
{
    // Arrange
    var pages = new[]
    {
        ("https://localhost:5173/products", "Product Catalog - B2Connect"),
        ("https://localhost:5173/cart", "Shopping Cart - B2Connect"),
        ("https://localhost:5173/checkout", "Checkout - B2Connect"),
        ("https://localhost:5174/dashboard", "Admin Dashboard - B2Connect")
    };
    
    foreach (var (url, expectedTitle) in pages)
    {
        // Act
        var page = await _browser.GoToAsync(url);
        var title = await page.GetTitleAsync();
        var h1 = await page.QuerySelectorAsync("h1");
        var h1Text = await h1?.TextContentAsync();
        
        // Assert
        Assert.Equal(expectedTitle, title);
        Assert.NotNull(h1);
        Assert.False(string.IsNullOrWhiteSpace(h1Text));
        
        // Heading hierarchy: H1 â†’ H2 â†’ H3, no skips
        var headings = await page.EvaluateAsync<List<int>>(
            "() => Array.from(document.querySelectorAll('h1,h2,h3,h4,h5,h6')).map(h => parseInt(h.tagName[1]))"
        );
        
        for (int i = 1; i < headings.Count; i++)
        {
            var diff = headings[i] - headings[i - 1];
            Assert.True(diff <= 1, $"Heading hierarchy broken: H{headings[i-1]} â†’ H{headings[i]}");
        }
    }
}
```

**Focus:** Each page has unique descriptive `<title>`, proper H1-H6 hierarchy  
**WCAG Reference:** WCAG 2.1 2.4.2 Page Titled  
**Acceptance:** Title unique per page, H1 present, no heading level skips

---

#### Test 5.2: Images Have Descriptive Alt Text
```csharp
[Fact]
public async Task Images_HaveDescriptiveAltText_NotGeneric()
{
    // Arrange
    var page = await _browser.GoToAsync("https://localhost:5173/products");
    
    // Act - Find all images
    var images = await page.QuerySelectorAllAsync("img");
    
    Assert.NotEmpty(images);
    
    var badAltTexts = new List<string>();
    
    foreach (var img in images)
    {
        var src = await img.GetAttributeAsync("src");
        var alt = await img.GetAttributeAsync("alt");
        
        // Images must have alt text
        Assert.False(string.IsNullOrWhiteSpace(alt),
            $"Image {src} missing alt attribute");
        
        // Alt text must be descriptive, not generic
        var badPatterns = new[] { "image", "picture", "img", "photo", "icon", "button" };
        var isGeneric = badPatterns.Any(p => alt?.ToLower().Contains(p) ?? false);
        
        if (isGeneric)
        {
            badAltTexts.Add($"{src}: '{alt}'");
        }
    }
    
    Assert.Empty(badAltTexts,
        $"Generic alt text found:\n{string.Join("\n", badAltTexts)}");
}
```

**Focus:** All images have meaningful alt text (not "image", "photo", "button")  
**WCAG Reference:** WCAG 2.1 1.1.1 Non-text Content  
**Acceptance:** Alt text describes content, not "image of...", tested with axe-core

---

## Test Summary Table

| Group | Test | Focus | WCAG | Effort |
|-------|------|-------|------|--------|
| 1.1 | Keyboard Navigation | TAB/ENTER works, focus visible | 2.1.1 | 3h |
| 1.2 | Keyboard Shortcuts | Shift+F, Shift+N, Ctrl+S | 2.1.3 | 3h |
| 1.3 | No Keyboard Traps | Escape closes modals | 2.1.2 | 3h |
| 2.1 | Screen Reader Support | Semantic HTML, ARIA | 1.3.1 | 4h |
| 2.2 | Form Labels | Label or aria-label | 1.3.1 | 3h |
| 2.3 | Error Announcements | role="alert" linked | 3.3.1 | 3h |
| 3.1 | Color Contrast | 4.5:1 ratio | 1.4.3 | 2h |
| 3.2 | Text Zoom | 200% resize safe | 1.4.4 | 2h |
| 4.1 | Video Captions | DE + EN, VTT files | 1.2.2 | 2h |
| 4.2 | Audio Description | For complex videos | 1.2.5 | 2h |
| 5.1 | Titles & Headings | Unique title, H1-H6 structure | 2.4.2 | 2h |
| 5.2 | Image Alt Text | Descriptive, not generic | 1.1.1 | 2h |
| **Total** | **12 Tests** | **Complete A11y Coverage** | **WCAG AA** | **35-40h** |

---

## Implementation Notes

### Tools & Automation
- **axe DevTools:** Automated a11y scanning per sprint
- **NVDA/JAWS Testing:** Manual testing with screen readers
- **Lighthouse:** Built-in accessibility audit (target: 90+)
- **Pa11y:** Command-line a11y testing in CI/CD

### Timeline
- **Weeks 1-2:** Keyboard & navigation fixes
- **Weeks 3-4:** Screen reader support
- **Weeks 5-6:** Visual & media fixes
- **Weeks 7-8:** Testing & documentation

### Success Criteria
- âœ… All 12 tests passing
- âœ… WCAG AA compliance verified (axe-core)
- âœ… Lighthouse a11y score >= 90
- âœ… Manual NVDA/JAWS testing passed
- âœ… 0 critical a11y issues

### Responsible Person
- **Frontend Lead:** BITV compliance owner
- **QA Engineer:** Accessibility testing
- **Designer:** Contrast ratio compliance

---

## Regulatory References

**BITV 2.0** (Barrierefreie Informationstechnik-Verordnung):
- Art. 1: Scope (all public digital services)
- Art. 4: WCAG 2.1 AA compliance required
- Art. 5: Annual compliance audit

**WCAG 2.1 Level AA Standards Referenced:**
- 1.1.1 Non-text Content
- 1.2.2 Captions (Prerecorded)
- 1.2.5 Audio Description
- 1.3.1 Info and Relationships
- 1.4.3 Contrast (Minimum) 4.5:1
- 1.4.4 Resize Text
- 2.1.1 Keyboard
- 2.1.2 No Keyboard Trap
- 2.1.3 Keyboard (No Exception)
- 2.4.2 Page Titled
- 3.3.1 Error Identification

**German Penalties:**
- â‚¬5,000-100,000 per violation
- Negative publicity (media attention)
- Enterprise customer contracts blocked

---

**Effort:** 40-45 hours (1.5 FTE, 1.5 weeks parallel to other P0 work)  
**Dependencies:** P0.1 (audit logging), frontend frameworks (Vue.js)  
**Status:** Ready for implementation
