#!/bin/bash
# Pre-commit hook to validate Central Package Management compliance
# This hook ensures all .csproj files use CPM and no hardcoded versions

set -e

echo "üîç Validating Central Package Management compliance..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

print_status() {
    local color=$1
    local message=$2
    echo -e "${color}${message}${NC}"
}

# Check if Directory.Packages.props exists
if [ ! -f "Directory.Packages.props" ]; then
    print_status $RED "‚ùå Directory.Packages.props not found in root directory"
    exit 1
fi

# Find all .csproj files
csproj_files=$(find . -name "*.csproj" -not -path "./bin/*" -not -path "./obj/*" -not -path "./node_modules/*" -not -path "./.ai/archive/*")

violations_found=0

for csproj_file in $csproj_files; do
    # Skip projects with CPM disabled
    if grep -q '<ManagePackageVersionsCentrally>false</ManagePackageVersionsCentrally>' "$csproj_file"; then
        continue
    fi
    
    # Check if file has PackageReference with Version attribute
    if grep -q 'PackageReference.*Version=' "$csproj_file"; then
        print_status $RED "‚ùå $csproj_file contains hardcoded package versions"
        print_status $YELLOW "   Remove Version attributes and ensure packages are defined in Directory.Packages.props"
        violations_found=$((violations_found + 1))
    fi

    # NOTE: In .NET 10+, Directory.Packages.props imports are automatic
    # No need to check for explicit imports
done

# Check for duplicate Directory.Packages.props files
duplicate_props=$(find . -name "Directory.Packages.props" | wc -l)
if [ "$duplicate_props" -gt 1 ]; then
    print_status $RED "‚ùå Multiple Directory.Packages.props files found:"
    find . -name "Directory.Packages.props"
    print_status $YELLOW "   Keep only the root Directory.Packages.props file"
    violations_found=$((violations_found + 1))
fi

if [ $violations_found -eq 0 ]; then
    print_status $GREEN "‚úÖ All projects comply with Central Package Management"
    exit 0
else
    print_status $RED "‚ùå Found $violations_found CPM compliance violations"
    print_status $YELLOW "   Fix violations before committing"
    print_status $YELLOW "   Run: ./scripts/ci-validate-dependencies.sh --fix"
    exit 1
fi