---
# B2Connect Aspire Hosting Configuration for Kubernetes
# Deploys centralized AppHost with service orchestration

apiVersion: v1
kind: Namespace
metadata:
  name: b2connect

---
# ConfigMap for service discovery
apiVersion: v1
kind: ConfigMap
metadata:
  name: aspire-config
  namespace: b2connect
data:
  Services__ApiGateway: "http://api-gateway:5000"
  Services__AuthService: "http://auth-service:5001"
  Services__TenantService: "http://tenant-service:5002"
  Services__LocalizationService: "http://localization-service:5003"
  ASPNETCORE_ENVIRONMENT: "Production"
  Logging__LogLevel__Default: "Information"
  HealthCheck__Enabled: "true"
  HealthCheck__Interval: "30000"

---
# PostgreSQL StatefulSet
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-pvc
  namespace: b2connect
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
  namespace: b2connect
spec:
  serviceName: postgres
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
      - name: postgres
        image: postgres:16-alpine
        env:
        - name: POSTGRES_USER
          value: "b2connect"
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: db-secrets
              key: postgres-password
        - name: POSTGRES_DB
          value: "b2connect_db"
        ports:
        - containerPort: 5432
        volumeMounts:
        - name: postgres-storage
          mountPath: /var/lib/postgresql/data
        livenessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - pg_isready -U b2connect
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - pg_isready -U b2connect
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: postgres-storage
        persistentVolumeClaim:
          claimName: postgres-pvc

---
apiVersion: v1
kind: Service
metadata:
  name: postgres
  namespace: b2connect
spec:
  clusterIP: None
  selector:
    app: postgres
  ports:
  - port: 5432
    targetPort: 5432

---
# Redis StatefulSet
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: redis-pvc
  namespace: b2connect
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: redis
  namespace: b2connect
spec:
  serviceName: redis
  replicas: 1
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
      - name: redis
        image: redis:7-alpine
        command:
        - redis-server
        - --appendonly
        - "yes"
        ports:
        - containerPort: 6379
        volumeMounts:
        - name: redis-storage
          mountPath: /data
        livenessProbe:
          exec:
            command:
            - redis-cli
            - ping
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          exec:
            command:
            - redis-cli
            - ping
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: redis-storage
        persistentVolumeClaim:
          claimName: redis-pvc

---
apiVersion: v1
kind: Service
metadata:
  name: redis
  namespace: b2connect
spec:
  clusterIP: None
  selector:
    app: redis
  ports:
  - port: 6379
    targetPort: 6379

---
# API Gateway Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-gateway
  namespace: b2connect
spec:
  replicas: 2
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: api-gateway
  template:
    metadata:
      labels:
        app: api-gateway
    spec:
      containers:
      - name: api-gateway
        image: b2connect-api-gateway:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 5000
        envFrom:
        - configMapRef:
            name: aspire-config
        env:
        - name: ASPNETCORE_URLS
          value: "http://+:5000"
        resources:
          requests:
            cpu: "250m"
            memory: "256Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"
        livenessProbe:
          httpGet:
            path: /health
            port: 5000
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
        readinessProbe:
          httpGet:
            path: /health
            port: 5000
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3

---
apiVersion: v1
kind: Service
metadata:
  name: api-gateway
  namespace: b2connect
spec:
  type: ClusterIP
  selector:
    app: api-gateway
  ports:
  - port: 5000
    targetPort: 5000
    protocol: TCP

---
# Auth Service Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth-service
  namespace: b2connect
spec:
  replicas: 2
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: auth-service
  template:
    metadata:
      labels:
        app: auth-service
    spec:
      containers:
      - name: auth-service
        image: b2connect-auth-service:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 5001
        envFrom:
        - configMapRef:
            name: aspire-config
        env:
        - name: ASPNETCORE_URLS
          value: "http://+:5001"
        - name: ConnectionStrings__AuthDb
          valueFrom:
            secretKeyRef:
              name: db-secrets
              key: auth-connection-string
        - name: Redis__Host
          value: "redis"
        - name: Redis__Port
          value: "6379"
        resources:
          requests:
            cpu: "250m"
            memory: "256Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"
        livenessProbe:
          httpGet:
            path: /health
            port: 5001
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 5001
          initialDelaySeconds: 10
          periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: auth-service
  namespace: b2connect
spec:
  type: ClusterIP
  selector:
    app: auth-service
  ports:
  - port: 5001
    targetPort: 5001
    protocol: TCP

---
# Tenant Service Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tenant-service
  namespace: b2connect
spec:
  replicas: 2
  selector:
    matchLabels:
      app: tenant-service
  template:
    metadata:
      labels:
        app: tenant-service
    spec:
      containers:
      - name: tenant-service
        image: b2connect-tenant-service:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 5002
        envFrom:
        - configMapRef:
            name: aspire-config
        env:
        - name: ASPNETCORE_URLS
          value: "http://+:5002"
        - name: ConnectionStrings__TenantDb
          valueFrom:
            secretKeyRef:
              name: db-secrets
              key: tenant-connection-string
        resources:
          requests:
            cpu: "250m"
            memory: "256Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"
        livenessProbe:
          httpGet:
            path: /health
            port: 5002
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 5002
          initialDelaySeconds: 10
          periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: tenant-service
  namespace: b2connect
spec:
  type: ClusterIP
  selector:
    app: tenant-service
  ports:
  - port: 5002
    targetPort: 5002
    protocol: TCP

---
# Localization Service Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: localization-service
  namespace: b2connect
spec:
  replicas: 2
  selector:
    matchLabels:
      app: localization-service
  template:
    metadata:
      labels:
        app: localization-service
    spec:
      containers:
      - name: localization-service
        image: b2connect-localization-service:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 5003
        envFrom:
        - configMapRef:
            name: aspire-config
        env:
        - name: ASPNETCORE_URLS
          value: "http://+:5003"
        - name: ConnectionStrings__LocalizationDb
          valueFrom:
            secretKeyRef:
              name: db-secrets
              key: localization-connection-string
        - name: Database__Provider
          value: "PostgreSQL"
        resources:
          requests:
            cpu: "250m"
            memory: "256Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"
        livenessProbe:
          httpGet:
            path: /health
            port: 5003
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 5003
          initialDelaySeconds: 10
          periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: localization-service
  namespace: b2connect
spec:
  type: ClusterIP
  selector:
    app: localization-service
  ports:
  - port: 5003
    targetPort: 5003
    protocol: TCP

---
# AppHost Deployment (Central Orchestrator)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: apphost
  namespace: b2connect
spec:
  replicas: 1
  selector:
    matchLabels:
      app: apphost
  template:
    metadata:
      labels:
        app: apphost
    spec:
      serviceAccountName: apphost
      containers:
      - name: apphost
        image: b2connect-apphost:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 9000
        envFrom:
        - configMapRef:
            name: aspire-config
        env:
        - name: ASPNETCORE_URLS
          value: "http://+:9000"
        resources:
          requests:
            cpu: "500m"
            memory: "512Mi"
          limits:
            cpu: "1000m"
            memory: "1024Mi"
        livenessProbe:
          httpGet:
            path: /health
            port: 9000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 9000
          initialDelaySeconds: 10
          periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: apphost
  namespace: b2connect
spec:
  type: LoadBalancer
  selector:
    app: apphost
  ports:
  - port: 9000
    targetPort: 9000
    protocol: TCP

---
# ServiceAccount for AppHost
apiVersion: v1
kind: ServiceAccount
metadata:
  name: apphost
  namespace: b2connect

---
# ClusterRole for AppHost (service discovery)
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: apphost-reader
rules:
- apiGroups: [""]
  resources: ["services", "endpoints"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["apps"]
  resources: ["deployments", "statefulsets"]
  verbs: ["get", "list", "watch"]

---
# ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: apphost-reader-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: apphost-reader
subjects:
- kind: ServiceAccount
  name: apphost
  namespace: b2connect
